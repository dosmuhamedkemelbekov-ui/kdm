<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–°—Ç—É–¥–µ–Ω—Ç—Ç—ñ–∫ “ö“±—Ä—ã–ª—ã—Ç–∞–π</title>
    <style>
        :root {
            --primary: #007AFF;
            --bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #1C1C1E;
            --text-secondary: #8E8E93;
            --border: #E5E5EA;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text-main);
            line-height: 1.4;
            overflow-x: hidden;
        }

        /* Layout */
        #app { display: flex; flex-direction: column; min-height: 100vh; padding-bottom: 80px; }
        .container { padding: 16px; width: 100%; max-width: 500px; margin: 0 auto; }
        header { 
            padding: 44px 16px 12px; 
            background: var(--card-bg); 
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
        }
        header h1 { font-size: 20px; font-weight: 700; margin: 0; color: var(--primary); }

        /* Auth Pages */
        .auth-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 2000;
            display: flex; flex-direction: column; padding: 40px 24px;
        }
        .auth-card { background: var(--card-bg); padding: 24px; border-radius: 20px; box-shadow: var(--shadow); }
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; margin-left: 4px; }
        input, select { 
            width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid var(--border); 
            font-size: 16px; outline: none; transition: border-color 0.2s;
        }
        input:focus { border-color: var(--primary); }
        .btn { 
            width: 100%; padding: 14px; border-radius: 14px; border: none; font-size: 16px; font-weight: 600; 
            cursor: pointer; transition: opacity 0.2s; background: var(--primary); color: white;
        }
        .btn:active { opacity: 0.7; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); margin-top: 10px; }
        .btn-small { padding: 8px 12px; font-size: 13px; width: auto; }

        /* Navigation */
        nav { 
            position: fixed; bottom: 0; left: 0; right: 0; height: 75px; 
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding-top: 8px; z-index: 1000;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-secondary); font-size: 10px; flex: 1; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }

        /* Components */
        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge-blue { background: #E1F0FF; color: var(--primary); }
        .badge-gray { background: #F2F2F7; color: var(--text-secondary); }
        
        /* Energy Indicator */
        .energy-box { display: flex; align-items: center; gap: 12px; }
        .energy-bar-wrap { flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
        .energy-bar-fill { height: 100%; background: linear-gradient(90deg, #007AFF, #34C759); transition: width 0.5s ease-out; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .stat-item { background: var(--card-bg); padding: 12px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .stat-val { font-size: 18px; font-weight: 700; display: block; }
        .stat-lab { font-size: 11px; color: var(--text-secondary); }

        /* Search */
        .search-bar { margin-bottom: 16px; position: relative; }
        .search-bar input { padding-left: 36px; }

        /* Tabs */
        .sub-tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; }
        .sub-tab { padding: 6px 12px; border-radius: 20px; background: var(--border); font-size: 13px; white-space: nowrap; cursor: pointer; }
        .sub-tab.active { background: var(--primary); color: white; }

        /* List Items */
        .list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .list-item:last-child { border-bottom: none; }
        .item-info h4 { margin: 0; font-size: 15px; }
        .item-info p { margin: 2px 0 0; font-size: 12px; color: var(--text-secondary); }

        /* Modals */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 3000; 
            display: none; align-items: flex-end; 
        }
        .modal-content { 
            background: white; width: 100%; border-radius: 20px 20px 0 0; padding: 24px; 
            max-height: 90vh; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s ease-out;
        }
        .modal-overlay.active { display: flex; }
        .modal-overlay.active .modal-content { transform: translateY(0); }

        /* Notification */
        #toast { 
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; 
            font-size: 14px; z-index: 4000; display: none; text-align: center; width: 80%;
        }

        /* Utils */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .mt-12 { margin-top: 12px; }
        .text-center { text-align: center; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <!-- Auth Screens -->
    <div id="auth-screen" class="auth-screen hidden">
        <div class="container">
            <h1 style="text-align: center; color: var(--primary); margin-bottom: 30px;">–°—Ç—É–¥–µ–Ω—Ç—Ç—ñ–∫ “ö“±—Ä—ã–ª—ã—Ç–∞–π</h1>
            
            <!-- Login Form -->
            <div id="login-box" class="auth-card">
                <h2 style="margin-top: 0;">–í—Ö–æ–¥</h2>
                <div class="input-group">
                    <label>–ù–∏–∫ –∏–ª–∏ –ì—Ä—É–ø–ø–∞</label>
                    <input type="text" id="login-id" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–î 24-1">
                </div>
                <div class="input-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="login-pass" placeholder="******">
                </div>
                <button class="btn" onclick="auth.login()">–í–æ–π—Ç–∏</button>
                <button class="btn btn-outline" onclick="auth.toggle(true)">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>

            <!-- Register Form -->
            <div id="register-box" class="auth-card hidden">
                <h2 style="margin-top: 0;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <div class="input-group"><label>–§–ò–û</label><input type="text" id="reg-name"></div>
                <div class="input-group"><label>–ù–∏–∫–Ω–µ–π–º</label><input type="text" id="reg-nick"></div>
                <div class="input-group"><label>–ì—Ä—É–ø–ø–∞</label><input type="text" id="reg-group"></div>
                <div class="input-group">
                    <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                    <select id="reg-role">
                        <option value="–î–µ–ø—É—Ç–∞—Ç">–î–µ–ø—É—Ç–∞—Ç</option>
                        <option value="–ú–∏–Ω–∏—Å—Ç—Ä">–ú–∏–Ω–∏—Å—Ç—Ä</option>
                        <option value="–°–µ–∫—Ä–µ—Ç–∞—Ä—å">–°–µ–∫—Ä–µ—Ç–∞—Ä—å</option>
                        <option value="–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å">–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>–û—Ç—Ä—è–¥</label>
                    <select id="reg-squad">
                        <option value="A">–û—Ç—Ä—è–¥ A</option><option value="B">–û—Ç—Ä—è–¥ B</option>
                        <option value="C">–û—Ç—Ä—è–¥ C</option><option value="D">–û—Ç—Ä—è–¥ D</option>
                    </select>
                </div>
                <div class="input-group"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="reg-pass"></div>
                <div class="input-group"><label>–ü–æ–≤—Ç–æ—Ä –ø–∞—Ä–æ–ª—è</label><input type="password" id="reg-pass2"></div>
                <button class="btn" onclick="auth.register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                <button class="btn btn-outline" onclick="auth.toggle(false)">–ù–∞–∑–∞–¥ –∫ –≤—Ö–æ–¥—É</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <header>
            <h1 id="page-title">Kurultai</h1>
            <div onclick="ui.showProfile()" style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span id="user-header-coins" style="font-weight: 600; font-size: 14px; color: var(--warning);">0 ü™ô</span>
                <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;" id="user-avatar">?</div>
            </div>
        </header>

        <main class="container" id="main-content"></main>

        <nav>
            <a href="#" class="nav-item active" onclick="ui.navigate('home', this)">
                <span class="nav-icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span>
            </a>
            <a href="#" class="nav-item" onclick="ui.navigate('tasks', this)">
                <span class="nav-icon">üéØ</span><span>–ó–∞–¥–∞—á–∏</span>
            </a>
            <a href="#" class="nav-item" onclick="ui.navigate('rating', this)">
                <span class="nav-icon">üèÜ</span><span>–†–µ–π—Ç–∏–Ω–≥</span>
            </a>
            <a href="#" class="nav-item" onclick="ui.navigate('store', this)">
                <span class="nav-icon">üõçÔ∏è</span><span>–ú–∞–≥–∞–∑–∏–Ω</span>
            </a>
            <a href="#" class="nav-item" onclick="ui.navigate('links', this)">
                <span class="nav-icon">ü§ù</span><span>–°–≤—è–∑–∫–∏</span>
            </a>
            <a href="#" class="nav-item hidden" id="admin-nav" onclick="ui.navigate('admin', this)">
                <span class="nav-icon">‚öôÔ∏è</span><span>–ê–¥–º–∏–Ω</span>
            </a>
        </nav>
    </div>

    <!-- Modals -->
    <div id="modal" class="modal-overlay" onclick="ui.closeModal(event)">
        <div class="modal-content" id="modal-inner"></div>
    </div>

    <script>
        /** STATE MANAGEMENT **/
        const state = {
            users: [],
            participants: [],
            tasks: [],
            store: [],
            alliances: [],
            events: [],
            energy: 80,
            seasonWeek: 1,
            lastUpdate: Date.now(),
            adminPass: 'admin123',
            currentUser: null,

            save() {
                localStorage.setItem('kurultai_data', JSON.stringify({
                    users: this.users,
                    participants: this.participants,
                    tasks: this.tasks,
                    store: this.store,
                    alliances: this.alliances,
                    events: this.events,
                    energy: this.energy,
                    seasonWeek: this.seasonWeek,
                    lastUpdate: this.lastUpdate,
                    adminPass: this.adminPass
                }));
            },

            load() {
                const data = localStorage.getItem('kurultai_data');
                if (data) {
                    const parsed = JSON.parse(data);
                    Object.assign(this, parsed);
                } else {
                    this.seedData();
                }
                const sessionUser = localStorage.getItem('kurultai_session');
                if (sessionUser) this.currentUser = JSON.parse(sessionUser);
            },

            seedData() {
                const roles = ['Strategist', 'Builder', 'Speaker', 'Support'];
                const squads = ['A', 'B', 'C', 'D'];
                for (let i = 1; i <= 26; i++) {
                    this.participants.push({
                        id: 'p' + i,
                        name: `–£—á–∞—Å—Ç–Ω–∏–∫ ${i}`,
                        nick: `user${i}`,
                        group: '–ë–î 24',
                        gameRole: roles[i % 4],
                        squad: squads[i % 4],
                        coins: 100,
                        influence: 50,
                        trust: 0,
                        monthlyLinks: [],
                        weeklyStats: { personal: 0, team: 0 },
                        secretRole: null,
                        titles: []
                    });
                }
                this.tasks = [
                    { id: 't1', title: '–°–º–µ—à–∞–π –æ—Ç—Ä—è–¥—ã', desc: '–°–æ–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–∑ 3 —á–µ–ª–æ–≤–µ–∫ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –æ—Ç—Ä—è–¥–æ–≤', type: 'team', rewardCoins: 80, rewardInfluence: 20, status: 'active', performers: [] },
                    { id: 't2', title: '–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞', desc: '–°–¥–µ–ª–∞–π 1 –ø–æ–ª–µ–∑–Ω—É—é –∑–∞–¥–∞—á—É –¥–ª—è –ø–∞—Ä–ª–∞–º–µ–Ω—Ç–∞', type: 'personal', rewardCoins: 30, rewardInfluence: 5, status: 'active', performers: [] },
                    { id: 't3', title: '–≠–Ω–µ—Ä–≥–∏—è –Ω–µ–¥–µ–ª–∏', desc: '–ó–∞–∫—Ä—ã—Ç—å 8 –∫–æ–º–∞–Ω–¥–Ω—ã—Ö –∑–∞–¥–∞—á', type: 'parliament', rewardCoins: 0, rewardInfluence: 0, status: 'active', performers: [] }
                ];
                this.store = [
                    { id: 's1', name: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ –ø–æ–µ–∑–¥–∫—É', price: 300, type: 'ind' },
                    { id: 's2', name: '–ö–æ—Ñ–µ –º–∏—Ç–∞–ø –ø–∞—Ä–ª–∞–º–µ–Ω—Ç–∞', price: 800, type: 'team' }
                ];
                this.save();
            }
        };

        /** CRYPTO SIMULATION (SubtleCrypto) **/
        async function hashString(str) {
            const msgBuffer = new TextEncoder().encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        /** AUTH MODULE **/
        const auth = {
            async register() {
                const name = document.getElementById('reg-name').value;
                const nick = document.getElementById('reg-nick').value;
                const group = document.getElementById('reg-group').value;
                const role = document.getElementById('reg-role').value;
                const squad = document.getElementById('reg-squad').value;
                const pass = document.getElementById('reg-pass').value;
                const pass2 = document.getElementById('reg-pass2').value;

                if (!name || !nick || pass.length < 6) return ui.toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è (–ø–∞—Ä–æ–ª—å –º–∏–Ω. 6 —Å–∏–º–≤)');
                if (pass !== pass2) return ui.toast('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                if (state.users.find(u => u.nick === nick)) return ui.toast('–ù–∏–∫ –∑–∞–Ω—è—Ç');

                const hashedPassword = await hashString(pass);
                const newUser = { id: 'u' + Date.now(), name, nick, group, role, squad, pass: hashedPassword };
                state.users.push(newUser);
                
                // Add to participants if not exists
                if (!state.participants.find(p => p.name === name)) {
                    state.participants.push({
                        id: newUser.id, name, nick, group, squad,
                        gameRole: ['Strategist', 'Builder', 'Speaker', 'Support'][Math.floor(Math.random()*4)],
                        coins: 100, influence: 50, trust: 0, monthlyLinks: [],
                        weeklyStats: { personal: 0, team: 0 }, titles: []
                    });
                }

                state.save();
                ui.toast('–£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è!');
                this.toggle(false);
            },

            async login() {
                const id = document.getElementById('login-id').value;
                const pass = document.getElementById('login-pass').value;
                const hashed = await hashString(pass);

                const user = state.users.find(u => (u.nick === id || u.group === id) && u.pass === hashed);
                if (user) {
                    state.currentUser = user;
                    localStorage.setItem('kurultai_session', JSON.stringify(user));
                    app.init();
                } else {
                    ui.toast('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                }
            },

            logout() {
                state.currentUser = null;
                localStorage.removeItem('kurultai_session');
                location.reload();
            },

            toggle(isReg) {
                document.getElementById('login-box').classList.toggle('hidden', isReg);
                document.getElementById('register-box').classList.toggle('hidden', !isReg);
            }
        };

        /** UI ENGINE **/
        const ui = {
            currentTab: 'home',

            toast(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg;
                t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 3000);
            },

            navigate(tab, el) {
                this.currentTab = tab;
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                if (el) el.classList.add('active');
                this.render();
            },

            render() {
                const content = document.getElementById('main-content');
                document.getElementById('page-title').textContent = this.currentTab.charAt(0).toUpperCase() + this.currentTab.slice(1);
                
                // Update header coins
                const part = state.participants.find(p => p.id === state.currentUser.id || p.name === state.currentUser.name);
                if (part) {
                    document.getElementById('user-header-coins').textContent = `${part.coins} ü™ô`;
                    document.getElementById('user-avatar').textContent = part.name[0];
                }

                switch(this.currentTab) {
                    case 'home': this.renderHome(content, part); break;
                    case 'tasks': this.renderTasks(content); break;
                    case 'rating': this.renderRating(content); break;
                    case 'store': this.renderStore(content, part); break;
                    case 'links': this.renderLinks(content, part); break;
                    case 'admin': this.renderAdmin(content); break;
                }
            },

            renderHome(container, part) {
                container.innerHTML = `
                    <div class="card">
                        <div class="energy-box">
                            <span style="font-size: 24px;">‚ö°</span>
                            <div class="energy-bar-wrap">
                                <div class="energy-bar-fill" style="width: ${state.energy}%"></div>
                            </div>
                            <span style="font-weight: 700;">${state.energy}%</span>
                        </div>
                        <p style="font-size: 12px; color: var(--text-secondary); margin: 8px 0 0;">
                            ${state.energy > 70 ? 'üî• –í—ã—Å–æ–∫–∞—è —ç–Ω–µ—Ä–≥–∏—è! +10% –∫ –Ω–∞–≥—Ä–∞–¥–∞–º' : state.energy < 30 ? '‚ùÑÔ∏è –ù–∏–∑–∫–∞—è —ç–Ω–µ—Ä–≥–∏—è. -10% –∫ –Ω–∞–≥—Ä–∞–¥–∞–º' : '–≠–Ω–µ—Ä–≥–∏—è –≤ –Ω–æ—Ä–º–µ.'}
                        </p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item"><span class="stat-val">${part ? part.influence : 0}</span><span class="stat-lab">Influence</span></div>
                        <div class="stat-item"><span class="stat-val">${part ? part.trust : 0}</span><span class="stat-lab">Trust (Week)</span></div>
                    </div>

                    <div class="card">
                        <h3>–°–µ–∑–æ–Ω 1: –ù–µ–¥–µ–ª—è ${state.seasonWeek}/4</h3>
                        <div class="energy-bar-wrap"><div class="energy-bar-fill" style="width: ${(state.seasonWeek/4)*100}%; background: var(--primary);"></div></div>
                    </div>

                    <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
                    ${state.events.slice(-5).reverse().map(e => `
                        <div class="list-item">
                            <div class="item-info">
                                <h4>${e.text}</h4>
                                <p>${new Date(e.time).toLocaleTimeString()}</p>
                            </div>
                        </div>
                    `).join('') || '<p class="text-secondary">–°–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>'}
                `;
            },

            renderTasks(container) {
                container.innerHTML = `
                    <div class="sub-tabs">
                        <div class="sub-tab active" onclick="ui.filterTasks('all', this)">–í—Å–µ</div>
                        <div class="sub-tab" onclick="ui.filterTasks('personal', this)">–õ–∏—á–Ω—ã–µ</div>
                        <div class="sub-tab" onclick="ui.filterTasks('team', this)">–ö–æ–º–∞–Ω–¥–Ω—ã–µ</div>
                    </div>
                    <div id="tasks-list">
                        ${state.tasks.map(t => `
                            <div class="card" onclick="ui.showTaskDetails('${t.id}')">
                                <div class="flex justify-between align-center">
                                    <span class="badge ${t.type === 'team' ? 'badge-blue' : 'badge-gray'}">${t.type}</span>
                                    <span style="font-weight: 700; color: var(--success);">+${t.rewardCoins} ü™ô</span>
                                </div>
                                <h3 style="margin: 12px 0 4px;">${t.title}</h3>
                                <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">${t.desc}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            filterTasks(type, el) {
                document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
                // Logic to filter...
            },

            renderRating(container) {
                const sorted = [...state.participants].sort((a,b) => b.influence - a.influence);
                container.innerHTML = `
                    <div class="sub-tabs">
                        <div class="sub-tab active">Influence</div>
                        <div class="sub-tab">Coins</div>
                        <div class="sub-tab">Squads</div>
                    </div>
                    ${sorted.map((p, i) => `
                        <div class="list-item">
                            <div class="flex align-center gap-12">
                                <span style="font-weight: 800; width: 24px;">${i+1}</span>
                                <div class="item-info">
                                    <h4>${p.name} <span style="font-size: 10px; color: var(--primary);">[${p.squad}]</span></h4>
                                    <p>${p.gameRole}</p>
                                </div>
                            </div>
                            <span style="font-weight: 700;">${p.influence} ‚ú®</span>
                        </div>
                    `).join('')}
                `;
            },

            renderStore(container, part) {
                container.innerHTML = `
                    <div class="card" style="background: var(--primary); color: white;">
                        <span style="font-size: 12px; opacity: 0.8;">–í–∞—à –±–∞–ª–∞–Ω—Å</span>
                        <div style="font-size: 28px; font-weight: 800;">${part.coins} ü™ô</div>
                    </div>
                    <div class="mt-12">
                        ${state.store.map(s => `
                            <div class="card flex justify-between align-center">
                                <div>
                                    <h4 style="margin: 0;">${s.name}</h4>
                                    <span class="badge badge-gray">${s.type === 'ind' ? '–õ–∏—á–Ω—ã–π' : '–ö–æ–º–∞–Ω–¥–Ω—ã–π'}</span>
                                </div>
                                <button class="btn btn-small" onclick="logic.buyItem('${s.id}')">${s.price} ü™ô</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            renderLinks(container, part) {
                const progress = part.monthlyLinks.length;
                container.innerHTML = `
                    <div class="card text-center">
                        <h3>–í–∞—à–∏ —Å–≤—è–∑–∫–∏ –º–µ—Å—è—Ü–∞</h3>
                        <div style="font-size: 40px; font-weight: 800; color: var(--primary);">${progress}/3</div>
                        <p style="color: var(--text-secondary); font-size: 12px;">–°–æ–±–µ—Ä–∏—Ç–µ 3 —Å–≤—è–∑–∫–∏ –¥–ª—è –±–æ–Ω—É—Å–∞ 50 ü™ô</p>
                    </div>
                    <h3>–° –∫–µ–º –≤—ã —Ä–∞–±–æ—Ç–∞–ª–∏:</h3>
                    ${part.monthlyLinks.map(id => {
                        const p = state.participants.find(x => x.id === id);
                        return `<div class="list-item"><h4>${p ? p.name : '–£–¥–∞–ª–µ–Ω'}</h4></div>`;
                    }).join('') || '<p class="text-secondary text-center">–°–≤—è–∑–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>'}
                    
                    <div class="mt-12">
                        <button class="btn btn-outline" onclick="ui.showTrustModal()">–û—Ç–¥–∞—Ç—å Trust</button>
                    </div>
                `;
            },

            renderAdmin(container) {
                container.innerHTML = `
                    <div id="admin-auth" class="auth-card">
                        <h3>–î–æ—Å—Ç—É–ø –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
                        <input type="password" id="admin-pass-input" placeholder="–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞">
                        <button class="btn mt-12" onclick="ui.checkAdmin()">–í–æ–π—Ç–∏</button>
                    </div>
                    <div id="admin-panel" class="hidden">
                        <div class="card">
                            <button class="btn" onclick="ui.showAddTask()">+ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
                            <button class="btn btn-outline" onclick="logic.runCeremony()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ü–µ—Ä–µ–º–æ–Ω–∏—é</button>
                        </div>
                        <div class="card">
                            <h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∑–æ–Ω–æ–º</h4>
                            <button class="btn btn-outline" onclick="logic.resetSeason()">–°–±—Ä–æ—Å —Å–µ–∑–æ–Ω–∞</button>
                            <button class="btn btn-outline" style="color: var(--danger); border-color: var(--danger);" onclick="logic.clearData()">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
                        </div>
                        <h4>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–ª—è –≤—ã–¥–∞—á–∏ –Ω–∞–≥—Ä–∞–¥</h4>
                        <div id="admin-parts-list">
                            ${state.participants.map(p => `
                                <div class="list-item">
                                    <span>${p.name}</span>
                                    <button class="btn btn-small" onclick="ui.showEditUser('${p.id}')">–†–µ–¥–∞–∫—Ç.</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            checkAdmin() {
                const pass = document.getElementById('admin-pass-input').value;
                if (pass === state.adminPass) {
                    document.getElementById('admin-auth').classList.add('hidden');
                    document.getElementById('admin-panel').classList.remove('hidden');
                } else {
                    this.toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                }
            },

            showProfile() {
                const part = state.participants.find(p => p.id === state.currentUser.id || p.name === state.currentUser.name);
                this.openModal(`
                    <div class="text-center">
                        <div style="width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 800; margin: 0 auto 16px;">${part.name[0]}</div>
                        <h2 style="margin: 0;">${part.name}</h2>
                        <p style="color: var(--text-secondary);">${state.currentUser.role} | –û—Ç—Ä—è–¥ ${part.squad}</p>
                        <div class="stats-grid mt-12">
                             <div class="stat-item"><span class="stat-val">${part.coins}</span><span class="stat-lab">Coins</span></div>
                             <div class="stat-item"><span class="stat-val">${part.influence}</span><span class="stat-lab">Influence</span></div>
                        </div>
                        <button class="btn btn-outline mt-12" style="color: var(--danger); border-color: var(--danger);" onclick="auth.logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
                    </div>
                `);
            },

            showTrustModal() {
                this.openModal(`
                    <h3>–û—Ç–¥–∞—Ç—å –¥–æ–≤–µ—Ä–∏–µ (Weekly)</h3>
                    <p style="font-size: 13px; color: var(--text-secondary);">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞, –∫–æ—Ç–æ—Ä–æ–º—É —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–¥–∞—Ç—å +10 Trust. –≠—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å 1 —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é.</p>
                    <select id="trust-select">
                        ${state.participants.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                    </select>
                    <button class="btn mt-12" onclick="logic.giveTrust()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                `);
            },

            showTaskDetails(id) {
                const t = state.tasks.find(x => x.id === id);
                this.openModal(`
                    <h3>${t.title}</h3>
                    <p>${t.desc}</p>
                    <div class="card">
                        <p>–ù–∞–≥—Ä–∞–¥–∞: <b>${t.rewardCoins} ü™ô</b> –∏ <b>${t.rewardInfluence} ‚ú®</b></p>
                    </div>
                    <button class="btn" onclick="ui.closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                `);
            },

            openModal(html) {
                document.getElementById('modal-inner').innerHTML = html;
                document.getElementById('modal').classList.add('active');
            },

            closeModal(e) {
                if (e && e.target !== document.getElementById('modal')) return;
                document.getElementById('modal').classList.remove('active');
            }
        };

        /** BUSINESS LOGIC **/
        const logic = {
            giveTrust() {
                const targetId = document.getElementById('trust-select').value;
                const target = state.participants.find(p => p.id === targetId);
                const me = state.participants.find(p => p.id === state.currentUser.id || p.name === state.currentUser.name);
                
                if (targetId === me.id) return ui.toast('–ù–µ–ª—å–∑—è –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –∑–∞ —Å–µ–±—è');
                
                target.trust += 10;
                state.events.push({ text: `${me.name} –≤—ã–¥–∞–ª –¥–æ–≤–µ—Ä–∏–µ ${target.name}`, time: Date.now() });
                state.save();
                ui.closeModal();
                ui.toast('–î–æ–≤–µ—Ä–∏–µ –ø–µ—Ä–µ–¥–∞–Ω–æ!');
                ui.render();
            },

            buyItem(id) {
                const item = state.store.find(i => i.id === id);
                const part = state.participants.find(p => p.id === state.currentUser.id || p.name === state.currentUser.name);
                
                if (part.coins < item.price) return ui.toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç');
                
                part.coins -= item.price;
                state.events.push({ text: `${part.name} –∫—É–ø–∏–ª ${item.name}`, time: Date.now() });
                state.save();
                ui.toast('–ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞!');
                ui.render();
            },

            runCeremony() {
                state.seasonWeek++;
                if (state.seasonWeek > 4) state.seasonWeek = 1;
                
                // Calculate Titles (simplified)
                const winner = state.participants.sort((a,b) => b.trust - a.trust)[0];
                state.events.push({ text: `–¶–µ—Ä–µ–º–æ–Ω–∏—è: ${winner.name} —Å—Ç–∞–ª –ì–æ–ª–æ—Å–æ–º –ö—É—Ä—É–ª—Ç–∞—è!`, time: Date.now() });
                
                // Reset weekly trust
                state.participants.forEach(p => p.trust = 0);
                
                state.save();
                ui.toast('–¶–µ—Ä–µ–º–æ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
                ui.render();
            },

            resetSeason() {
                if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å —Å–µ–∑–æ–Ω? –≠—Ç–æ –æ–±–Ω—É–ª–∏—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏.')) {
                    state.participants.forEach(p => {
                        p.influence = 50;
                        p.coins = 100;
                        p.monthlyLinks = [];
                    });
                    state.seasonWeek = 1;
                    state.save();
                    location.reload();
                }
            },

            clearData() {
                if (confirm('–£–î–ê–õ–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï?')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        };

        /** INITIALIZATION **/
        const app = {
            init() {
                state.load();
                if (!state.currentUser) {
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('app').classList.add('hidden');
                } else {
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    
                    // Show admin tab if role matches
                    const role = state.currentUser.role.toLowerCase();
                    if (role.includes('–ø—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å') || role.includes('–∞–¥–º–∏–Ω')) {
                        document.getElementById('admin-nav').classList.remove('hidden');
                    }
                    
                    ui.render();
                }
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
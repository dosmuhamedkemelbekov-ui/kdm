<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>“ö“±—Ä—ã–ª—ã—Ç–∞–π App</title>
    <style>
        :root {
            --primary: #007AFF;
            --bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #1C1C1E;
            --text-secondary: #8E8E93;
            --border: #E5E5EA;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
            --success: #34C759;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text-main); line-height: 1.4; padding-top: env(safe-area-inset-top); }

        /* Auth */
        .auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; overflow-y: auto; padding: 40px 24px; }
        .auth-card { background: var(--card-bg); padding: 24px; border-radius: 24px; box-shadow: var(--shadow); }
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; padding-left: 4px; }
        input, select { width: 100%; padding: 14px; border-radius: 14px; border: 1px solid var(--border); font-size: 16px; outline: none; background: white; }

        /* Navigation */
        nav { position: fixed; bottom: 0; left: 0; right: 0; height: 84px; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-top: 1px solid var(--border); display: flex; justify-content: space-around; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: var(--text-secondary); font-size: 10px; flex: 1; border: none; background: none; padding: 10px 0; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 22px; margin-bottom: 2px; }

        /* Layout */
        header { padding: 20px 16px 12px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        header h1 { font-size: 20px; margin: 0; color: var(--primary); font-weight: 800; }
        .container { padding: 16px; padding-bottom: 100px; max-width: 500px; margin: 0 auto; }

        /* Components */
        .card { background: var(--card-bg); border-radius: 20px; padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.02); }
        .btn { width: 100%; padding: 16px; border-radius: 16px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; background: var(--primary); color: white; transition: 0.2s; }
        .btn:active { opacity: 0.7; transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); margin-top: 8px; }

        /* Profile & Avatar */
        .profile-header { text-align: center; margin-bottom: 24px; }
        .avatar-wrapper { position: relative; width: 100px; height: 100px; margin: 0 auto 12px; }
        .avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid white; box-shadow: var(--shadow); background: #eee; }
        .avatar-edit { position: absolute; bottom: 0; right: 0; background: var(--primary); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; font-size: 18px; cursor: pointer; }
        #file-input { display: none; }

        /* Rating */
        .rating-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .rating-rank { width: 30px; font-weight: 800; color: var(--text-secondary); }
        .rating-img { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; object-fit: cover; background: #ddd; }
        .rating-info { flex: 1; }
        .rating-info b { display: block; font-size: 15px; }
        .rating-info span { font-size: 12px; color: var(--text-secondary); }
        .rating-score { font-weight: 800; color: var(--primary); font-size: 16px; }

        .hidden { display: none !important; }
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 25px; font-size: 14px; z-index: 5000; display: none; text-align: center; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <!-- Auth -->
    <div id="auth-screen" class="auth-screen">
        <div class="auth-card">
            <h1 style="text-align: center; margin-bottom: 24px;">“ö“∞–†–´–õ–¢–ê–ô</h1>
            <div id="login-box">
                <div class="input-group"><label>Name / –ê—Ç—ã</label><input type="text" id="login-id"></div>
                <div class="input-group"><label>Password / “ö“±–ø–∏—è —Å”©–∑</label><input type="password" id="login-pass"></div>
                <button class="btn" onclick="auth.login()">Login</button>
                <button class="btn btn-outline" onclick="auth.toggle(true)">Register</button>
            </div>
            <div id="register-box" class="hidden">
                <div class="input-group"><label>Full Name / –§–ò–û</label><input type="text" id="reg-name"></div>
                <div class="input-group"><label>Group / –¢–æ–ø</label><input type="text" id="reg-group"></div>
                <div class="input-group"><label>Position / “ö—ã–∑–º–µ—Ç—ñ</label><input type="text" id="reg-pos"></div>
                <div class="input-group"><label>Password / “ö“±–ø–∏—è —Å”©–∑</label><input type="password" id="reg-pass"></div>
                <button class="btn" onclick="auth.register()">Create Account</button>
                <button class="btn btn-outline" onclick="auth.toggle(false)">Back</button>
            </div>
        </div>
    </div>

    <!-- Main -->
    <div id="app" class="hidden">
        <header>
            <h1 id="ui-title">“ö“∞–†–´–õ–¢–ê–ô</h1>
            <div onclick="ui.nav('profile')" style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span id="h-points" style="font-weight: 700; color: var(--primary);">0</span>
                <img id="h-avatar" class="avatar" style="width: 32px; height: 32px; margin: 0;">
            </div>
        </header>

        <div class="container" id="content"></div>

        <nav>
            <button class="nav-item active" onclick="ui.nav('home', this)"><span class="nav-icon">üè†</span><span class="nav-text" data-key="nav_home">–ë–∞—Å—Ç—ã –±–µ—Ç</span></button>
            <button class="nav-item" onclick="ui.nav('tasks', this)"><span class="nav-icon">üéØ</span><span class="nav-text" data-key="nav_tasks">–ó–∞–¥–∞—á–∏</span></button>
            <button class="nav-item" onclick="ui.nav('rating', this)"><span class="nav-icon">üèÜ</span><span class="nav-text" data-key="nav_rating">–†–µ–π—Ç–∏–Ω–≥</span></button>
            <button class="nav-item" onclick="ui.nav('profile', this)"><span class="nav-icon">üë§</span><span class="nav-text" data-key="nav_profile">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
        </nav>
    </div>

    <script>
        const LANGS = {
            ru: {
                nav_home: "–ì–ª–∞–≤–Ω–∞—è", nav_tasks: "–ó–∞–¥–∞—á–∏", nav_rating: "–†–µ–π—Ç–∏–Ω–≥", nav_profile: "–ü—Ä–æ—Ñ–∏–ª—å",
                points: "–ë–∞–ª–ª—ã", trust: "–î–æ–≤–µ—Ä–∏–µ", pos: "–î–æ–ª–∂–Ω–æ—Å—Ç—å", lang: "–Ø–∑—ã–∫",
                sync: "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è", logout: "–í—ã–π—Ç–∏", upload: "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ",
                tasks_title: "–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏", rating_title: "–¢–æ–ø —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
            },
            kz: {
                nav_home: "–ë–∞—Å—Ç—ã –±–µ—Ç", nav_tasks: "–¢–∞–ø—Å—ã—Ä–º–∞–ª–∞—Ä", nav_rating: "–†–µ–π—Ç–∏–Ω–≥", nav_profile: "–ü—Ä–æ—Ñ–∏–ª—å",
                points: "“∞–ø–∞–π–ª–∞—Ä", trust: "–°–µ–Ω—ñ–º", pos: "“ö—ã–∑–º–µ—Ç—ñ", lang: "–¢—ñ–ª",
                sync: "–°–∏–Ω—Ö—Ä–æ–Ω–¥–∞—É", logout: "–®—ã“ì—É", upload: "–§–æ—Ç–æ –∂“Ø–∫—Ç–µ—É",
                tasks_title: "–¢“±—Ä–∞“õ—Ç—ã —Ç–∞–ø—Å—ã—Ä–º–∞–ª–∞—Ä", rating_title: "“Æ–∑–¥—ñ–∫ “õ–∞—Ç—ã—Å—É—à—ã–ª–∞—Ä"
            },
            en: {
                nav_home: "Home", nav_tasks: "Tasks", nav_rating: "Rating", nav_profile: "Profile",
                points: "Points", trust: "Trust", pos: "Position", lang: "Language",
                sync: "Sync to Cloud", logout: "Logout", upload: "Upload Photo",
                tasks_title: "Permanent Tasks", rating_title: "Top Participants"
            }
        };

        const state = {
            lang: localStorage.getItem('q_lang') || 'kz',
            currentUser: null,
            participants: JSON.parse(localStorage.getItem('q_parts')) || [],
            googleUrl: 'https://script.google.com/macros/s/AKfycbyie9wdr7dpAmSD3hiEvaA8lNYswAiXbYe8Szi2lpgJTDvG_TakNj3eYb5vCYniT7QoFQ/exec',
            
            save() {
                localStorage.setItem('q_parts', JSON.stringify(this.participants));
                localStorage.setItem('q_lang', this.lang);
            }
        };

        const t = (key) => LANGS[state.lang][key] || key;

        const auth = {
            toggle(isReg) {
                document.getElementById('login-box').classList.toggle('hidden', isReg);
                document.getElementById('register-box').classList.toggle('hidden', !isReg);
            },
            register() {
                const name = document.getElementById('reg-name').value;
                const pos = document.getElementById('reg-pos').value;
                const group = document.getElementById('reg-group').value;
                const pass = document.getElementById('reg-pass').value;

                if (!name || pass.length < 4) return ui.toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');

                const newUser = { 
                    id: Date.now(), name, position: pos, group, pass, 
                    points: 0, trust: 0, avatar: null 
                };
                state.participants.push(newUser);
                state.save();
                ui.toast('–£—Å–ø–µ—à–Ω–æ!');
                this.toggle(false);
            },
            login() {
                const id = document.getElementById('login-id').value;
                const pass = document.getElementById('login-pass').value;
                const u = state.participants.find(x => x.name === id && x.pass === pass);
                if (u) {
                    state.currentUser = u;
                    localStorage.setItem('q_sess', u.id);
                    app.init();
                } else ui.toast('Error');
            }
        };

        const ui = {
            nav(view, el) {
                this.currentView = view;
                document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
                if (el) el.classList.add('active');
                this.render();
            },
            toast(m) {
                const b = document.getElementById('toast');
                b.textContent = m; b.style.display = 'block';
                setTimeout(() => b.style.display = 'none', 2000);
            },
            render() {
                const main = document.getElementById('content');
                const u = state.currentUser;
                
                // Header update
                document.getElementById('h-points').textContent = u.points;
                document.getElementById('h-avatar').src = u.avatar || 'https://www.w3schools.com/howto/img_avatar.png';

                if (this.currentView === 'home') {
                    main.innerHTML = `
                        <div class="card">
                            <h2>${u.name}</h2>
                            <p style="color:var(--text-secondary)">${u.position}</p>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                            <div class="card" style="text-align:center"><b style="font-size:24px">${u.points}</b><br><small>${t('points')}</small></div>
                            <div class="card" style="text-align:center"><b style="font-size:24px">${u.trust}</b><br><small>${t('trust')}</small></div>
                        </div>
                        <button class="btn btn-outline" onclick="logic.sync()">${t('sync')}</button>
                    `;
                }

                if (this.currentView === 'tasks') {
                    main.innerHTML = `<h3>${t('tasks_title')}</h3>` + [
                        {n: '–°–æ–±—Ä–∞–Ω–∏–µ', p: 10}, {n: '–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞', p: 20}, {n: '–ü–æ–º–æ—â—å', p: 15}
                    ].map(x => `
                        <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                            <b>${x.n}</b> <span style="font-weight:800; color:var(--primary)">+${x.p}</span>
                        </div>
                    `).join('');
                }

                if (this.currentView === 'rating') {
                    const sorted = [...state.participants].sort((a,b) => b.points - a.points);
                    main.innerHTML = `<h3>${t('rating_title')}</h3>` + sorted.map((p, i) => `
                        <div class="rating-item">
                            <div class="rating-rank">${i+1}</div>
                            <img class="rating-img" src="${p.avatar || 'https://www.w3schools.com/howto/img_avatar.png'}">
                            <div class="rating-info">
                                <b>${p.name}</b>
                                <span>${p.position}</span>
                            </div>
                            <div class="rating-score">${p.points}</div>
                        </div>
                    `).join('');
                }

                if (this.currentView === 'profile') {
                    main.innerHTML = `
                        <div class="profile-header">
                            <div class="avatar-wrapper">
                                <img id="p-avatar" class="avatar" src="${u.avatar || 'https://www.w3schools.com/howto/img_avatar.png'}">
                                <label for="file-input" class="avatar-edit">‚úé</label>
                                <input type="file" id="file-input" accept="image/*" onchange="logic.uploadAvatar(event)">
                            </div>
                            <h2 style="margin:0">${u.name}</h2>
                            <p style="color:var(--text-secondary); margin:4px 0">${u.group} ‚Ä¢ ${u.position}</p>
                        </div>

                        <div class="card">
                            <label style="font-size:12px; color:var(--text-secondary)">${t('lang')}</label>
                            <select onchange="logic.changeLang(this.value)" style="margin-top:8px">
                                <option value="kz" ${state.lang === 'kz' ? 'selected' : ''}>“ö–∞–∑–∞“õ—à–∞</option>
                                <option value="ru" ${state.lang === 'ru' ? 'selected' : ''}>–†—É—Å—Å–∫–∏–π</option>
                                <option value="en" ${state.lang === 'en' ? 'selected' : ''}>English</option>
                            </select>
                        </div>

                        <button class="btn btn-outline" style="color:var(--danger); border-color: #ff3b30" onclick="app.logout()">${t('logout')}</button>
                    `;
                }
            }
        };

        const logic = {
            changeLang(l) {
                state.lang = l;
                state.save();
                // Update nav text immediately
                document.querySelectorAll('.nav-text').forEach(el => {
                    el.textContent = t(el.dataset.key);
                });
                ui.render();
            },
            uploadAvatar(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    state.currentUser.avatar = event.target.result;
                    state.save();
                    ui.toast('Photo updated!');
                    ui.render();
                };
                reader.readAsDataURL(file);
            },
            async sync() {
                ui.toast('Syncing...');
                try {
                    await fetch(state.googleUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({
                            type: 'sync',
                            participants: state.participants
                        })
                    });
                    ui.toast('Done!');
                } catch(e) { ui.toast('Error'); }
            }
        };

        const app = {
            init() {
                state.load();
                const sess = localStorage.getItem('q_sess');
                if (sess) {
                    state.currentUser = state.participants.find(x => x.id == sess);
                    if (state.currentUser) {
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('app').classList.remove('hidden');
                        ui.nav('home');
                        return;
                    }
                }
                document.getElementById('auth-screen').classList.remove('hidden');
            },
            logout() {
                localStorage.removeItem('q_sess');
                location.reload();
            }
        };

        window.onload = app.init;
    </script>
</body>
</html>


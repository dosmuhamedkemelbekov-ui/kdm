<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KDM HUB | Студенческий Портал</title>
    <!-- Подключаем Telegram Web App SDK и стили -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #05070A;
            --text: #ffffff;
            --accent: #00D1FF; /* Электрический голубой - цвет КДМ */
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow-x: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .font-space { font-family: 'Space Grotesk', sans-serif; }

        .glass {
            background: var(--glass);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
        }

        .accent-gradient {
            background: linear-gradient(135deg, #00D1FF 0%, #007AFF 100%);
        }

        .nav-btn { opacity: 0.4; transition: 0.3s; }
        .nav-btn.active { opacity: 1; color: var(--accent); }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: slideUp 0.3s ease-out; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .kdm-card {
            background: linear-gradient(180deg, rgba(0, 209, 255, 0.1) 0%, rgba(5, 7, 10, 0) 100%);
            border: 1px solid rgba(0, 209, 255, 0.2);
        }

        .loader {
            width: 40px;
            height: 40px;
            border: 3px solid var(--glass-border);
            border-left-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        #registration-screen, #login-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: none; flex-direction: column; padding: 30px;
        }

        .input-kdm {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 16px;
            width: 100%;
            outline: none;
            transition: 0.3s;
        }
        .input-kdm:focus { border-color: var(--accent); box-shadow: 0 0 15px rgba(0, 209, 255, 0.2); }
    </style>
</head>
<body class="pb-24">

    <!-- Loader -->
    <div id="loader" class="fixed inset-0 bg-[#05070A] z-[10000] flex items-center justify-center">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-xs font-bold tracking-widest text-cyan-500 uppercase">KDM HUB Loading...</p>
        </div>
    </div>

    <!-- Регистрация -->
    <section id="registration-screen" class="justify-center">
        <div class="mb-10 text-center">
            <h2 class="text-3xl font-extrabold font-space text-cyan-400">KDM HUB</h2>
            <p class="text-gray-400 text-sm mt-2">Стань частью молодежного движения</p>
        </div>
        <div class="space-y-4">
            <input type="text" id="reg-name" class="input-kdm" placeholder="ФИО полностью">
            <input type="text" id="reg-group" class="input-kdm" placeholder="Факультет и Группа">
            <select id="reg-unit" class="input-kdm text-gray-400">
                <option value="Media">Media Unit</option>
                <option value="Volunteers">Volunteers Unit</option>
                <option value="Sport">Sport & Health</option>
                <option value="Culture">Culture & Arts</option>
                <option value="Event">Event Management</option>
            </select>
            <input type="password" id="reg-pass" class="input-kdm" placeholder="Придумайте пароль">
            <button onclick="submitRegistration()" class="w-full py-4 accent-gradient rounded-2xl font-bold text-white shadow-lg shadow-cyan-500/20 uppercase mt-4">Зарегистрироваться</button>
        </div>
    </section>

    <!-- Основное приложение -->
    <div id="main-app" style="display:none">
        <!-- Header -->
        <header class="p-6 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div id="user-avatar" class="w-12 h-12 rounded-2xl accent-gradient p-[2px]">
                    <div class="bg-[#05070A] w-full h-full rounded-[14px] flex items-center justify-center overflow-hidden">
                        <i class="fas fa-user-graduate text-cyan-400"></i>
                    </div>
                </div>
                <div>
                    <h1 id="user-name" class="text-sm font-bold">...</h1>
                    <div class="flex items-center gap-2">
                        <p id="user-rank" class="text-[10px] font-extrabold text-cyan-400 uppercase">Активист</p>
                    </div>
                </div>
            </div>
            <div class="text-right">
                <p id="user-unit-top" class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">...</p>
                <p id="user-group" class="text-[9px] font-medium text-cyan-500/50 uppercase">...</p>
            </div>
        </header>

        <main class="px-6">
            <!-- Главная: Баланс -->
            <section id="dashboard" class="tab-content active">
                <div class="kdm-card rounded-[32px] p-8 text-center mb-8">
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-[0.2em] mb-4">Ваш баланс K-Coins</p>
                    <div class="flex justify-center items-center gap-3 mb-6">
                        <span id="balance" class="text-6xl font-space font-bold tracking-tighter">0</span>
                        <div class="text-left">
                            <p class="text-cyan-400 font-bold leading-none">KC</p>
                            <p class="text-[10px] text-gray-500 uppercase">коинов</p>
                        </div>
                    </div>
                    <div class="w-full h-2 bg-white/5 rounded-full overflow-hidden">
                        <div id="progress" class="h-full accent-gradient" style="width: 0%"></div>
                    </div>
                    <p id="level-guide" class="text-[9px] text-gray-500 mt-3 font-bold uppercase">... до звания Организатор</p>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xs font-bold uppercase tracking-widest text-gray-500">Последние баллы</h2>
                </div>
                <div id="history-list" class="space-y-3">
                    <!-- Сюда придут данные -->
                </div>
            </section>

            <!-- Задания -->
            <section id="earn" class="tab-content">
                <h2 class="text-2xl font-space font-bold mb-6">Миссии КДМ</h2>
                <div class="space-y-4">
                    <div class="glass p-5 flex justify-between items-center">
                        <div>
                            <p class="font-bold text-sm">Участие в форуме</p>
                            <p class="text-[10px] text-gray-400">Присутствие + отчет</p>
                        </div>
                        <button onclick="openProofModal('Участие в форуме', 25)" class="px-4 py-2 bg-cyan-500/10 border border-cyan-500/30 rounded-xl text-cyan-400 text-[10px] font-bold">+25 KC</button>
                    </div>
                    <div class="glass p-5 flex justify-between items-center">
                        <div>
                            <p class="font-bold text-sm">Пост в соцсетях</p>
                            <p class="text-[10px] text-gray-400">Отметка @KDM_HUB</p>
                        </div>
                        <button onclick="openProofModal('Пост в соцсетях', 15)" class="px-4 py-2 bg-cyan-500/10 border border-cyan-500/30 rounded-xl text-cyan-400 text-[10px] font-bold">+15 KC</button>
                    </div>
                    <div class="glass p-5 flex justify-between items-center">
                        <div>
                            <p class="font-bold text-sm">Организация ивента</p>
                            <p class="text-[10px] text-gray-400">Для лидеров юнитов</p>
                        </div>
                        <button onclick="openProofModal('Организация ивента', 100)" class="px-4 py-2 bg-cyan-500/10 border border-cyan-500/30 rounded-xl text-cyan-400 text-[10px] font-bold">+100 KC</button>
                    </div>
                </div>
            </section>

            <!-- Магазин Мерча -->
            <section id="shop" class="tab-content">
                <h2 class="text-2xl font-space font-bold mb-6">KDM Market</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass p-4 text-center">
                        <div class="h-24 bg-cyan-500/5 rounded-xl mb-3 flex items-center justify-center">
                            <i class="fas fa-tshirt text-2xl text-cyan-500"></i>
                        </div>
                        <p class="text-[10px] font-bold uppercase mb-1">Худи КДМ</p>
                        <button onclick="buyItem('Худи КДМ', 500)" class="w-full py-2 accent-gradient rounded-lg text-[10px] font-bold">500 KC</button>
                    </div>
                    <div class="glass p-4 text-center">
                        <div class="h-24 bg-cyan-500/5 rounded-xl mb-3 flex items-center justify-center">
                            <i class="fas fa-ticket-alt text-2xl text-cyan-500"></i>
                        </div>
                        <p class="text-[10px] font-bold uppercase mb-1">Билет в Кино</p>
                        <button onclick="buyItem('Билет в Кино', 200)" class="w-full py-2 accent-gradient rounded-lg text-[10px] font-bold">200 KC</button>
                    </div>
                </div>
            </section>

            <!-- Рейтинг -->
            <section id="rating" class="tab-content">
                <h2 class="text-2xl font-space font-bold mb-6">Лидеры</h2>
                <div id="leaderboard-list" class="space-y-4">
                    <!-- Сюда придут лидеры -->
                </div>
            </section>
        </main>

        <!-- Navbar -->
        <nav class="fixed bottom-6 left-6 right-6 glass p-3 flex justify-around items-center z-50 shadow-2xl">
            <button onclick="showTab('dashboard')" class="nav-btn active flex-1 flex flex-col items-center">
                <i class="fas fa-home text-lg"></i>
            </button>
            <button onclick="showTab('earn')" class="nav-btn flex-1 flex flex-col items-center">
                <i class="fas fa-tasks text-lg"></i>
            </button>
            <div class="flex-1 flex justify-center -mt-12">
                <button onclick="startScan()" class="w-14 h-14 accent-gradient rounded-full flex items-center justify-center text-white shadow-lg shadow-cyan-500/40">
                    <i class="fas fa-qrcode text-xl"></i>
                </button>
            </div>
            <button onclick="showTab('shop')" class="nav-btn flex-1 flex flex-col items-center">
                <i class="fas fa-shopping-bag text-lg"></i>
            </button>
            <button onclick="showTab('rating')" class="nav-btn flex-1 flex flex-col items-center">
                <i class="fas fa-trophy text-lg"></i>
            </button>
        </nav>
    </div>

    <!-- Модалка отчета -->
    <div id="proof-modal" class="fixed inset-0 bg-black/90 z-[10001] hidden flex items-center justify-center p-6 backdrop-blur-md">
        <div class="glass p-8 w-full max-w-sm">
            <h3 class="font-space text-lg font-bold text-cyan-400 mb-2 uppercase">Подтверждение</h3>
            <p id="modal-task-name" class="text-xs text-gray-400 mb-4">Название задачи</p>
            <textarea id="proof-input" class="w-full h-32 bg-white/5 border border-white/10 rounded-2xl p-4 text-sm text-white outline-none focus:border-cyan-500 mb-6" placeholder="Вставьте ссылку на фото/пост или описание выполненной работы..."></textarea>
            <div class="flex gap-4">
                <button onclick="closeProofModal()" class="flex-1 text-xs font-bold uppercase opacity-50">Отмена</button>
                <button onclick="submitTaskWithProof()" class="flex-1 py-3 accent-gradient rounded-xl text-xs font-bold text-white">Отправить</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // ЗАМЕНИ НА СВОЙ API URL
        const API_URL = "ТВОЙ_GOOGLE_APPS_SCRIPT_URL"; 
        
        let userLocal = {};
        let currentTask = {};

        // 1. Инициализация данных
        async function syncData() {
            const userId = tg.initDataUnsafe.user?.id || "12345678"; // Тестовый ID для браузера
            
            try {
                const res = await fetch(`${API_URL}?action=getUser&id=${userId}`);
                const data = await res.json();
                
                if (!data.registered) {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('registration-screen').style.display = 'flex';
                } else {
                    userLocal = data;
                    userLocal.id = userId;
                    renderApp(data);
                    document.getElementById('loader').style.display = 'none';
                }
            } catch (e) {
                console.error("Ошибка загрузки:", e);
                // Для теста в браузере показываем приложение через 1.5 сек
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('registration-screen').style.display = 'flex';
                }, 1500);
            }
        }

        // 2. Регистрация
        async function submitRegistration() {
            const name = document.getElementById('reg-name').value;
            const group = document.getElementById('reg-group').value;
            const unit = document.getElementById('reg-unit').value;
            const pass = document.getElementById('reg-pass').value;

            if(!name || !group || !pass) return alert("Пожалуйста, заполни все поля!");

            document.getElementById('loader').style.display = 'flex';
            
            try {
                const userId = tg.initDataUnsafe.user?.id || "12345678";
                await fetch(`${API_URL}?action=register&id=${userId}&name=${encodeURIComponent(name)}&group=${encodeURIComponent(group)}&unit=${encodeURIComponent(unit)}&password=${encodeURIComponent(pass)}`);
                syncData();
            } catch (e) {
                // Если нет бэкенда, просто пускаем для теста
                userLocal = { name, group, unit, balance: 0, history: [] };
                renderApp(userLocal);
                document.getElementById('loader').style.display = 'none';
            }
        }

        // 3. Рендер приложения
        function renderApp(data) {
            document.getElementById('registration-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            document.getElementById('user-name').innerText = data.name;
            document.getElementById('user-group').innerText = data.group;
            document.getElementById('user-unit-top').innerText = data.unit + " Unit";
            document.getElementById('balance').innerText = data.balance || 0;
            
            // Расчет рангов
            let rank = "Активист", next = 100, progress = (data.balance % 100);
            if(data.balance >= 1000) { rank = "Легенда КДМ"; next = 0; progress = 100; }
            else if(data.balance >= 500) { rank = "Амбассадор"; next = 1000; progress = ((data.balance-500)/500)*100; }
            else if(data.balance >= 300) { rank = "Лидер"; next = 500; progress = ((data.balance-300)/200)*100; }
            else if(data.balance >= 100) { rank = "Организатор"; next = 300; progress = ((data.balance-100)/200)*100; }
            
            document.getElementById('user-rank').innerText = rank;
            document.getElementById('progress').style.width = progress + '%';
            document.getElementById('level-guide').innerText = next === 0 ? "Максимальный уровень" : `До звания ${getRankName(next)} еще ${next - data.balance} KC`;

            // История
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = (data.history || []).map(h => `
                <div class="glass p-4 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-cyan-500/10 flex items-center justify-center">
                            <i class="fas fa-check text-[10px] text-cyan-400"></i>
                        </div>
                        <p class="text-[11px] font-bold">${h.action}</p>
                    </div>
                    <p class="text-xs font-black text-cyan-400">+${h.amount} KC</p>
                </div>
            `).join('');
        }

        function getRankName(pts) {
            if(pts === 300) return "Организатор";
            if(pts === 500) return "Лидер";
            if(pts === 1000) return "Амбассадор";
            return "Легенда";
        }

        // Навигация
        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            if(id === 'rating') loadLeaderboard();
        }

        // Модалка отчетов
        function openProofModal(name, amount) {
            currentTask = { name, amount };
            document.getElementById('modal-task-name').innerText = name + " (" + amount + " KC)";
            document.getElementById('proof-modal').style.display = 'flex';
        }

        function closeProofModal() { document.getElementById('proof-modal').style.display = 'none'; }

        async function submitTaskWithProof() {
            const proof = document.getElementById('proof-input').value;
            if(!proof) return alert("Пожалуйста, предоставь доказательства!");
            
            // Здесь отправка на бэкенд для модерации
            alert("Ваш отчет отправлен на проверку куратору юнита!");
            closeProofModal();
        }

        async function buyItem(name, price) {
            if (userLocal.balance < price) return alert("Недостаточно K-Coins!");
            if (confirm(`Купить ${name} за ${price} KC?`)) {
                alert("Заявка на покупку отправлена! Подойдите в офис КДМ для получения.");
            }
        }

        function startScan() {
            tg.showScanQrPopup({ text: "Сканируй код от куратора" }, function(text) {
                alert("Код принят: " + text);
                tg.closeScanQrPopup();
            });
        }

        async function loadLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = `<div class="text-center p-10"><div class="loader mx-auto"></div></div>`;
            
            // Заглушка для теста
            const leaders = [
                {name: "Алина Серикова", unit: "Media", balance: 1250},
                {name: "Арман Идрисов", unit: "Sport", balance: 980},
                {name: "Бекарыс Нуртас", unit: "Volunteers", balance: 740}
            ];

            list.innerHTML = leaders.map((u, i) => `
                <div class="glass p-4 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <span class="text-xs font-black opacity-20">0${i+1}</span>
                        <div>
                            <p class="text-sm font-bold">${u.name}</p>
                            <p class="text-[9px] uppercase text-cyan-500">${u.unit} Unit</p>
                        </div>
                    </div>
                    <p class="font-space font-bold text-cyan-400">${u.balance} KC</p>
                </div>
            `).join('');
        }

        syncData();
    </script>
</body>
</html>

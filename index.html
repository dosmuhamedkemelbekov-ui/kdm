<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–°—Ç—É–¥–µ–Ω—Ç—Ç—ñ–∫ “ö“±—Ä—ã–ª—ã—Ç–∞–π</title>
    <style>
        :root {
            --primary: #007AFF;
            --bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #1C1C1E;
            --text-secondary: #8E8E93;
            --border: #E5E5EA;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text-main); line-height: 1.4; overflow-x: hidden; }

        #app { display: flex; flex-direction: column; min-height: 100vh; padding-bottom: 90px; }
        .container { padding: 16px; width: 100%; max-width: 500px; margin: 0 auto; }
        
        /* Auth */
        .auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; overflow-y: auto; padding: 40px 24px; }
        .auth-card { background: var(--card-bg); padding: 24px; border-radius: 20px; box-shadow: var(--shadow); }
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; margin-left: 4px; }
        input, select, textarea { width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid var(--border); font-size: 16px; outline: none; background: #fff; }

        /* UI Elements */
        header { padding: 44px 16px 12px; background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        header h1 { font-size: 18px; font-weight: 700; margin: 0; color: var(--primary); }
        
        .btn { width: 100%; padding: 14px; border-radius: 14px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { opacity: 0.7; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); margin-top: 10px; }
        .btn-small { padding: 8px 12px; font-size: 12px; width: auto; border-radius: 10px; }
        .btn-danger { background: var(--danger); }

        nav { position: fixed; bottom: 0; left: 0; right: 0; height: 84px; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding-top: 8px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-secondary); font-size: 10px; flex: 1; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }

        .card { background: var(--card-bg); border-radius: 18px; padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.02); position: relative; overflow: hidden; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-right: 4px; }
        .badge-primary { background: #E1F0FF; color: var(--primary); }
        .badge-success { background: #E2F9E9; color: var(--success); }
        .badge-gray { background: #F2F2F7; color: var(--text-secondary); }

        .energy-bar-wrap { height: 10px; background: var(--border); border-radius: 5px; overflow: hidden; margin: 10px 0; }
        .energy-bar-fill { height: 100%; background: linear-gradient(90deg, #007AFF, #34C759); transition: width 0.6s ease; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .stat-item { background: var(--card-bg); padding: 14px; border-radius: 16px; text-align: center; border: 1px solid var(--border); }
        .stat-val { font-size: 18px; font-weight: 800; display: block; }
        .stat-lab { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

        .list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .list-item:last-child { border-bottom: none; }
        
        .sub-tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch; }
        .sub-tab { padding: 8px 16px; border-radius: 20px; background: var(--border); font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer; color: var(--text-secondary); }
        .sub-tab.active { background: var(--primary); color: white; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; display: none; align-items: flex-end; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; border-radius: 24px 24px 0 0; padding: 24px; max-height: 85vh; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal.active .modal-content { transform: translateY(0); }

        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: white; padding: 12px 24px; border-radius: 25px; font-size: 14px; z-index: 4000; display: none; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .hidden { display: none !important; }
        
        .title-badge { background: #FFD700; color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 800; margin-left: 4px; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="auth-screen">
        <div class="container">
            <h1 style="text-align: center; font-size: 28px; margin-bottom: 40px;">“ö“∞–†–´–õ–¢–ê–ô</h1>
            <div id="login-box" class="auth-card">
                <h2 style="margin: 0 0 20px;">–í—Ö–æ–¥</h2>
                <div class="input-group"><label>–ù–∏–∫–Ω–µ–π–º –∏–ª–∏ –ì—Ä—É–ø–ø–∞</label><input type="text" id="login-id"></div>
                <div class="input-group"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="login-pass"></div>
                <button class="btn" onclick="auth.login()">–í–æ–π—Ç–∏</button>
                <button class="btn btn-outline" onclick="auth.toggle(true)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
            <div id="register-box" class="auth-card hidden">
                <h2 style="margin: 0 0 20px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <div class="input-group"><label>–§–ò–û</label><input type="text" id="reg-name"></div>
                <div class="input-group"><label>–ì—Ä—É–ø–ø–∞</label><input type="text" id="reg-group"></div>
                <div class="input-group"><label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                    <select id="reg-role-title">
                        <option value="–î–µ–ø—É—Ç–∞—Ç">–î–µ–ø—É—Ç–∞—Ç</option>
                        <option value="–ú–∏–Ω–∏—Å—Ç—Ä">–ú–∏–Ω–∏—Å—Ç—Ä</option>
                        <option value="–°–µ–∫—Ä–µ—Ç–∞—Ä—å">–°–µ–∫—Ä–µ—Ç–∞—Ä—å</option>
                        <option value="–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å">–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å</option>
                    </select>
                </div>
                <div class="input-group"><label>–û—Ç—Ä—è–¥</label>
                    <select id="reg-squad">
                        <option value="A">–û—Ç—Ä—è–¥ A</option><option value="B">–û—Ç—Ä—è–¥ B</option><option value="C">–û—Ç—Ä—è–¥ C</option><option value="D">–û—Ç—Ä—è–¥ D</option>
                    </select>
                </div>
                <div class="input-group"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="reg-pass"></div>
                <button class="btn" onclick="auth.register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                <button class="btn btn-outline" onclick="auth.toggle(false)">–ù–∞–∑–∞–¥</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <header>
            <h1>“ö“∞–†–´–õ–¢–ê–ô</h1>
            <div onclick="ui.showProfile()" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <span id="header-coins" style="font-weight: 700; color: var(--warning);">0 ü™ô</span>
                <div id="header-avatar" style="width: 34px; height: 34px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px;">?</div>
            </div>
        </header>

        <main class="container" id="view-content"></main>

        <nav>
            <a href="#" class="nav-item active" onclick="ui.navigate('home', this)"><span class="nav-icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></a>
            <a href="#" class="nav-item" onclick="ui.navigate('tasks', this)"><span class="nav-icon">üéØ</span><span>–ó–∞–¥–∞—á–∏</span></a>
            <a href="#" class="nav-item" onclick="ui.navigate('rating', this)"><span class="nav-icon">üèÜ</span><span>–†–µ–π—Ç–∏–Ω–≥</span></a>
            <a href="#" class="nav-item" onclick="ui.navigate('store', this)"><span class="nav-icon">üõçÔ∏è</span><span>–ú–∞–≥–∞–∑–∏–Ω</span></a>
            <a href="#" class="nav-item" onclick="ui.navigate('links', this)"><span class="nav-icon">ü§ù</span><span>–°–≤—è–∑–∫–∏</span></a>
            <a href="#" id="admin-nav" class="nav-item hidden" onclick="ui.navigate('admin', this)"><span class="nav-icon">‚öôÔ∏è</span><span>–ê–¥–º–∏–Ω</span></a>
        </nav>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal" onclick="ui.closeModal(event)">
        <div class="modal-content" id="modal-inner"></div>
    </div>

    <script>
        /** STATE **/
        const state = {
            users: [],
            participants: [],
            tasks: [],
            store: [],
            alliances: [],
            events: [],
            energy: 80,
            seasonWeek: 1,
            history: [],
            googleUrl: 'https://script.google.com/macros/s/AKfycbw8dxgWRVSUBKW9YNFmu7qx7mIKqdxicyHH_43eAlkTrmZEdUdVvvrq0FMsaIppttg/exec',
            currentUser: null,

            save() {
                localStorage.setItem('kurultai_pro_data', JSON.stringify({
                    users: this.users, participants: this.participants, tasks: this.tasks,
                    store: this.store, alliances: this.alliances, events: this.events,
                    energy: this.energy, seasonWeek: this.seasonWeek, history: this.history
                }));
            },
            load() {
                const data = localStorage.getItem('kurultai_pro_data');
                if (data) Object.assign(this, JSON.parse(data)); else this.seed();
                const session = localStorage.getItem('kurultai_pro_session');
                if (session) this.currentUser = JSON.parse(session);
            },
            seed() {
                const squads = ['A', 'B', 'C', 'D'], roles = ['Strategist', 'Builder', 'Speaker', 'Support'];
                for(let i=1; i<=26; i++) {
                    this.participants.push({
                        id: 'p'+i, name: '–£—á–∞—Å—Ç–Ω–∏–∫ '+i, gameRole: roles[i%4], coins: 100, influence: 50, trust: 0,
                        squad: squads[i%4], monthlyLinks: [], weeklyStats: { personal: 0, team: 0 }, secretRole: null, titles: [], lastTrustGivenTo: null
                    });
                }
                this.tasks = [
                    { id: 't1', title: '–°–º–µ—à–∞–π –æ—Ç—Ä—è–¥—ã', desc: '–°–æ–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–∑ 3 —á–µ–ª–æ–≤–µ–∫ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –æ—Ç—Ä—è–¥–æ–≤', type: 'team', rewardCoins: 80, rewardInfluence: 20, status: 'active', performers: [] },
                    { id: 't2', title: '–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞', desc: '–°–¥–µ–ª–∞–π 1 –ø–æ–ª–µ–∑–Ω—É—é –∑–∞–¥–∞—á—É –¥–ª—è –ø–∞—Ä–ª–∞–º–µ–Ω—Ç–∞', type: 'personal', rewardCoins: 30, rewardInfluence: 5, status: 'active', performers: [] },
                    { id: 't3', title: '–≠–Ω–µ—Ä–≥–∏—è –Ω–µ–¥–µ–ª–∏', desc: '–ó–∞–∫—Ä—ã—Ç—å 8 –∫–æ–º–∞–Ω–¥–Ω—ã—Ö –∑–∞–¥–∞—á –≤—Å–µ–º –ø–∞—Ä–ª–∞–º–µ–Ω—Ç–æ–º', type: 'parliament', rewardCoins: 0, rewardInfluence: 0, status: 'active', performers: [] }
                ];
                this.store = [
                    { id: 's1', name: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ –ø–æ–µ–∑–¥–∫—É', price: 300, type: 'ind' },
                    { id: 's2', name: '–ë–µ–π–¥–∂ Top Kurultai', price: 200, type: 'ind' },
                    { id: 's3', name: '–ö–æ—Ñ–µ –º–∏—Ç–∞–ø –ø–∞—Ä–ª–∞–º–µ–Ω—Ç–∞', price: 800, type: 'team' }
                ];
                this.assignSecretRoles();
                this.save();
            },
            assignSecretRoles() {
                const roles = ['Observer', 'Catalyst', 'Diplomat'];
                const shuffled = [...this.participants].sort(() => 0.5 - Math.random());
                roles.forEach((r, i) => shuffled[i].secretRole = r);
            }
        };

        /** CRYPTO **/
        async function hash(s) {
            const m = new TextEncoder().encode(s), b = await crypto.subtle.digest('SHA-256', m);
            return Array.from(new Uint8Array(b)).map(x => x.toString(16).padStart(2, '0')).join('');
        }

        /** AUTH **/
        const auth = {
            async register() {
                const name = document.getElementById('reg-name').value, group = document.getElementById('reg-group').value,
                    roleT = document.getElementById('reg-role-title').value, squad = document.getElementById('reg-squad').value,
                    pass = document.getElementById('reg-pass').value;
                if (!name || pass.length < 6) return ui.toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ (–ø–∞—Ä–æ–ª—å 6+)');
                const hPass = await hash(pass);
                const user = { id: 'u'+Date.now(), name, group, roleTitle: roleT, squad, pass: hPass };
                state.users.push(user);
                let p = state.participants.find(x => x.name === name);
                if (!p) {
                    p = { id: user.id, name, gameRole: 'Strategist', coins: 100, influence: 50, trust: 0, squad, monthlyLinks: [], weeklyStats: { personal: 0, team: 0 }, titles: [] };
                    state.participants.push(p);
                }
                state.save(); ui.toast('–£—Å–ø–µ—Ö!'); this.toggle(false);
            },
            async login() {
                const id = document.getElementById('login-id').value, pass = document.getElementById('login-pass').value;
                const h = await hash(pass);
                const u = state.users.find(x => (x.name === id || x.group === id) && x.pass === h);
                if (u) { state.currentUser = u; localStorage.setItem('kurultai_pro_session', JSON.stringify(u)); app.init(); }
                else ui.toast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
            },
            toggle(r) { document.getElementById('login-box').classList.toggle('hidden', r); document.getElementById('register-box').classList.toggle('hidden', !r); }
        };

        /** LOGIC **/
        const logic = {
            getParticipant() { return state.participants.find(p => p.name === state.currentUser.name); },
            
            calculateReward(task, performerIds) {
                let coins = task.rewardCoins, influence = task.rewardInfluence;
                if (task.type === 'team') {
                    const n = performerIds.length;
                    const mult = n >= 4 ? 2.0 : n === 3 ? 1.5 : n === 2 ? 1.2 : 1.0;
                    coins *= mult; influence *= mult;
                    const squads = new Set(performerIds.map(id => state.participants.find(p => p.id === id).squad));
                    if (squads.size > 1) coins += 15;
                    state.alliances.forEach(a => {
                        if (squads.has(a.s1) && squads.has(a.s2)) { coins *= 1.3; influence *= 1.3; }
                    });
                }
                if (state.energy > 70) { coins *= 1.1; influence *= 1.1; }
                else if (state.energy < 30) { coins *= 0.9; influence *= 0.9; }
                return { coins: Math.round(coins), influence: Math.round(influence) };
            },

            completeTask(taskId, performerIds) {
                const task = state.tasks.find(t => t.id === taskId);
                const reward = this.calculateReward(task, performerIds);
                performerIds.forEach(id => {
                    const p = state.participants.find(x => x.id === id);
                    p.coins += reward.coins; p.influence += reward.influence;
                    if (task.type === 'team') {
                        p.weeklyStats.team++;
                        performerIds.forEach(oid => {
                            if (oid !== id && !p.monthlyLinks.includes(oid)) {
                                p.monthlyLinks.push(oid);
                                if (p.monthlyLinks.length === 3) p.coins += 50;
                                if (p.secretRole === 'Diplomat') p.coins += 10;
                            }
                        });
                        state.energy = Math.min(100, state.energy + 2);
                    } else {
                        p.weeklyStats.personal++;
                    }
                    if (p.secretRole === 'Catalyst' && task.type === 'team') p.influence += 5;
                });
                state.events.push({ text: `–ó–∞–¥–∞—á–∞ "${task.title}" –≤—ã–ø–æ–ª–Ω–µ–Ω–∞`, time: Date.now() });
                state.save(); ui.toast('–ù–∞–≥—Ä–∞–¥—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã'); ui.render();
            },

            async sync() {
                ui.toast('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...');
                try {
                    await fetch(state.googleUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(state) });
                    ui.toast('–î–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ!');
                } catch(e) { ui.toast('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏'); }
            }
        };

        /** UI **/
        const ui = {
            current: 'home',
            navigate(tab, el) { 
                this.current = tab; 
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                if(el) el.classList.add('active'); 
                this.render(); 
            },
            toast(m) { const t = document.getElementById('toast'); t.textContent = m; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000); },
            
            render() {
                const cont = document.getElementById('view-content'), p = logic.getParticipant();
                document.getElementById('header-coins').textContent = p.coins + ' ü™ô';
                document.getElementById('header-avatar').textContent = p.name[0];
                
                if (this.current === 'home') this.viewHome(cont, p);
                if (this.current === 'tasks') this.viewTasks(cont);
                if (this.current === 'rating') this.viewRating(cont);
                if (this.current === 'store') this.viewStore(cont, p);
                if (this.current === 'links') this.viewLinks(cont, p);
                if (this.current === 'admin') this.viewAdmin(cont);
            },

            viewHome(c, p) {
                c.innerHTML = `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:700;">–≠–Ω–µ—Ä–≥–∏—è –ü–∞—Ä–ª–∞–º–µ–Ω—Ç–∞</span>
                            <span style="font-weight:800; color:var(--primary);">${state.energy}%</span>
                        </div>
                        <div class="energy-bar-wrap"><div class="energy-bar-fill" style="width:${state.energy}%"></div></div>
                        <p style="font-size:11px; color:var(--text-secondary); margin-top:4px;">
                            ${state.energy > 70 ? 'üî• –ë–æ–Ω—É—Å +10% –∫ –Ω–∞–≥—Ä–∞–¥–∞–º –∞–∫—Ç–∏–≤–µ–Ω' : state.energy < 30 ? '‚ö†Ô∏è –ù–∞–≥—Ä–∞–¥—ã —Å–Ω–∏–∂–µ–Ω—ã –Ω–∞ 10%' : '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ–∂–∏–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π'}
                        </p>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item"><span class="stat-val">${p.influence}</span><span class="stat-lab">Influence</span></div>
                        <div class="stat-item"><span class="stat-val">${p.trust}</span><span class="stat-lab">Trust (Week)</span></div>
                    </div>
                    <div class="card">
                        <h3>–°–µ–∑–æ–Ω 1 ‚Ä¢ –ù–µ–¥–µ–ª—è ${state.seasonWeek}/4</h3>
                        <div class="energy-bar-wrap"><div class="energy-bar-fill" style="width:${(state.seasonWeek/4)*100}%; background:var(--primary);"></div></div>
                        <div style="margin-top:12px;">
                            ${p.titles.map(t => `<span class="badge badge-success">${t}</span>`).join('')}
                        </div>
                    </div>
                    <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
                    ${state.events.slice(-5).reverse().map(e => `<div class="list-item"><span>${e.text}</span><span style="font-size:10px; color:var(--text-secondary);">${new Date(e.time).toLocaleTimeString()}</span></div>`).join('') || '<p>–°–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>'}
                `;
            },

            viewTasks(c) {
                c.innerHTML = `<h3>–ó–∞–¥–∞—á–∏</h3>` + state.tasks.map(t => `
                    <div class="card" onclick="ui.showTask('${t.id}')">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <span class="badge badge-primary">${t.type}</span>
                            <span style="color:var(--success); font-weight:700;">+${t.rewardCoins} ü™ô</span>
                        </div>
                        <div style="font-weight:700;">${t.title}</div>
                        <div style="font-size:12px; color:var(--text-secondary);">${t.desc}</div>
                    </div>
                `).join('');
                c.innerHTML += `<h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –ê–ª—å—è–Ω—Å—ã</h3>` + (state.alliances.length ? state.alliances.map(a => `<div class="card">–û—Ç—Ä—è–¥—ã ${a.s1} + ${a.s2} (–ë–æ–Ω—É—Å x1.3)</div>`).join('') : '<p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–ª—å—è–Ω—Å–æ–≤</p>');
            },

            viewRating(c) {
                c.innerHTML = `<div class="sub-tabs">
                    <div class="sub-tab active" onclick="ui.sortRating('influence', this)">Influence</div>
                    <div class="sub-tab" onclick="ui.sortRating('coins', this)">Coins</div>
                    <div class="sub-tab" onclick="ui.sortRating('teamwork', this)">Teamwork</div>
                    <div class="sub-tab" onclick="ui.sortRating('squads', this)">Squads</div>
                </div><div id="rating-list"></div>`;
                this.sortRating('influence');
            },

            sortRating(type, el) {
                if(el) { document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active')); el.classList.add('active'); }
                const list = document.getElementById('rating-list');
                let html = '';
                if(type === 'squads') {
                    const s = {A:0, B:0, C:0, D:0};
                    state.participants.forEach(p => s[p.squad] += p.influence);
                    Object.entries(s).sort((a,b) => b[1]-a[1]).forEach(([k,v]) => {
                        html += `<div class="list-item"><span>–û—Ç—Ä—è–¥ ${k}</span><span style="font-weight:800;">${v} ‚ú®</span></div>`;
                    });
                } else {
                    const sorted = [...state.participants].sort((a,b) => (type==='influence'?b.influence-a.influence : type==='coins'?b.coins-a.coins : b.weeklyStats.team-a.weeklyStats.team));
                    sorted.forEach((p, i) => {
                        html += `<div class="list-item">
                            <div style="display:flex; align-items:center;">
                                <span style="font-weight:800; width:20px;">${i+1}</span>
                                <div><b>${p.name}</b> ${p.titles.length?'<span class="title-badge">Title</span>':''}<br><small>${p.squad} ‚Ä¢ ${p.gameRole}</small></div>
                            </div>
                            <span style="font-weight:700;">${type==='influence'?p.influence:type==='coins'?p.coins:p.weeklyStats.team}</span>
                        </div>`;
                    });
                }
                list.innerHTML = html;
            },

            viewStore(c, p) {
                c.innerHTML = `<div class="card" style="background:var(--primary); color:white; text-align:center;">
                    <p style="margin:0; font-size:12px; opacity:0.8;">–í–∞—à –±–∞–ª–∞–Ω—Å</p>
                    <div style="font-size:32px; font-weight:800;">${p.coins} ü™ô</div>
                </div>` + state.store.map(s => `
                    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                        <div><b>${s.name}</b><br><small>${s.type==='ind'?'–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ':'–ö–æ–º–∞–Ω–¥–∞'}</small></div>
                        <button class="btn btn-small" onclick="ui.buy('${s.id}')">${s.price} ü™ô</button>
                    </div>
                `).join('');
            },

            viewLinks(c, p) {
                c.innerHTML = `
                    <div class="card" style="text-align:center;">
                        <h3>–°–≤—è–∑–∫–∏ –º–µ—Å—è—Ü–∞</h3>
                        <div style="font-size:48px; font-weight:800; color:var(--primary);">${p.monthlyLinks.length}/3</div>
                        <p style="font-size:12px; color:var(--text-secondary);">–°–æ–±–µ—Ä–∏—Ç–µ 3 —Å–≤—è–∑–∫–∏ –¥–ª—è –±–æ–Ω—É—Å–∞ 50 ü™ô</p>
                    </div>
                    <button class="btn btn-outline" onclick="ui.modalTrust()">‚ù§Ô∏è –í—ã–¥–∞—Ç—å –¥–æ–≤–µ—Ä–∏–µ</button>
                    <h3>–ò—Å—Ç–æ—Ä–∏—è —Å–≤—è–∑–µ–π</h3>
                    ${p.monthlyLinks.map(id => {
                        const op = state.participants.find(x => x.id === id);
                        return `<div class="list-item"><span>${op?.name || '–£—á–∞—Å—Ç–Ω–∏–∫'}</span><span class="badge badge-primary">${op?.squad}</span></div>`;
                    }).join('') || '<p>–°–≤—è–∑–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>'}
                `;
            },

            viewAdmin(c) {
                c.innerHTML = `
                    <div id="admin-lock" class="card">
                        <h3>–ó–∞—â–∏—â–µ–Ω–Ω—ã–π –≤—Ö–æ–¥</h3>
                        <input type="password" id="admin-pass" placeholder="–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞">
                        <button class="btn mt-12" onclick="ui.unlockAdmin()">–í–æ–π—Ç–∏</button>
                    </div>
                    <div id="admin-body" class="hidden">
                        <button class="btn" onclick="ui.modalAddTask()">+ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
                        <button class="btn btn-outline" onclick="ui.modalWeeklyCeremony()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ü–µ—Ä–µ–º–æ–Ω–∏—é</button>
                        <button class="btn btn-outline" onclick="logic.sync()">üì§ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Google</button>
                        <button class="btn btn-outline" onclick="ui.modalAlliance()">ü§ù –°–æ–∑–¥–∞—Ç—å –∞–ª—å—è–Ω—Å</button>
                        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏</h3>
                        ${state.participants.map(p => `
                            <div class="list-item">
                                <span>${p.name} [${p.squad}]</span>
                                <button class="btn btn-small" onclick="ui.modalCompleteTaskFor('${p.id}')">–ó–∞—Å—á–∏—Ç–∞—Ç—å –∑–∞–¥–∞—á—É</button>
                            </div>
                        `).join('')}
                        <div class="card" style="margin-top:20px; border-color:var(--danger);">
                            <button class="btn btn-danger" onclick="localStorage.clear(); location.reload();">–°–ë–†–û–°–ò–¢–¨ –í–°–ï</button>
                        </div>
                    </div>
                `;
            },

            unlockAdmin() {
                if(document.getElementById('admin-pass').value === 'admin123') {
                    document.getElementById('admin-lock').classList.add('hidden');
                    document.getElementById('admin-body').classList.remove('hidden');
                } else ui.toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
            },

            showProfile() {
                const p = logic.getParticipant();
                this.openModal(`
                    <div style="text-align:center;">
                        <div style="width:70px; height:70px; background:var(--primary); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px; font-weight:800; margin:0 auto 15px;">${p.name[0]}</div>
                        <h2>${p.name}</h2>
                        <p>${state.currentUser.roleTitle} ‚Ä¢ –û—Ç—Ä—è–¥ ${p.squad}</p>
                        <div class="stats-grid">
                            <div class="stat-item"><span class="stat-val">${p.coins}</span><span class="stat-lab">Coins</span></div>
                            <div class="stat-item"><span class="stat-val">${p.influence}</span><span class="stat-lab">Influence</span></div>
                        </div>
                        <button class="btn btn-danger" onclick="localStorage.removeItem('kurultai_pro_session'); location.reload();">–í—ã–π—Ç–∏</button>
                    </div>
                `);
            },

            modalTrust() {
                const p = logic.getParticipant();
                this.openModal(`
                    <h3>–í—ã–¥–∞—Ç—å –¥–æ–≤–µ—Ä–∏–µ</h3>
                    <p style="font-size:12px; color:var(--text-secondary);">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞. –ù–µ–ª—å–∑—è –≤—ã–±–∏—Ä–∞—Ç—å —Ç–æ–≥–æ –∂–µ —á–µ–ª–æ–≤–µ–∫–∞ –¥–≤–∞–∂–¥—ã –ø–æ–¥—Ä—è–¥.</p>
                    <div class="input-group">
                        <select id="trust-target">
                            ${state.participants.filter(x => x.id !== p.id && x.id !== p.lastTrustGivenTo).map(x => `<option value="${x.id}">${x.name}</option>`).join('')}
                        </select>
                    </div>
                    <button class="btn" onclick="ui.confirmTrust()">–í—ã–¥–∞—Ç—å +10 Trust</button>
                `);
            },

            confirmTrust() {
                const targetId = document.getElementById('trust-target').value, me = logic.getParticipant(), target = state.participants.find(x => x.id === targetId);
                target.trust += 10; me.lastTrustGivenTo = targetId;
                state.events.push({ text: `${me.name} –≤—ã—Ä–∞–∑–∏–ª –¥–æ–≤–µ—Ä–∏–µ ${target.name}`, time: Date.now() });
                state.save(); ui.closeModal(); ui.toast('–î–æ–≤–µ—Ä–∏–µ –≤—ã–¥–∞–Ω–æ!'); ui.render();
            },

            showTask(id) {
                const t = state.tasks.find(x => x.id === id);
                this.openModal(`
                    <h3>${t.title}</h3>
                    <p>${t.desc}</p>
                    <div class="card" style="background:var(--bg);">
                        –ù–∞–≥—Ä–∞–¥–∞: <b>${t.rewardCoins} coins</b> –∏ <b>${t.rewardInfluence} influence</b>
                    </div>
                    <p style="font-size:11px; color:var(--text-secondary);">–ó–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≤ –∫–æ–Ω—Ü–µ –¥–Ω—è.</p>
                `);
            },

            modalCompleteTaskFor(pid) {
                this.openModal(`
                    <h3>–ó–∞—Å—á–∏—Ç–∞—Ç—å –∑–∞–¥–∞—á—É</h3>
                    <div class="input-group">
                        <label>–ó–∞–¥–∞—á–∞</label>
                        <select id="task-select">
                            ${state.tasks.map(t => `<option value="${t.id}">${t.title}</option>`).join('')}
                        </select>
                    </div>
                    <div class="input-group">
                        <label>–î—Ä—É–≥–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é ID)</label>
                        <input type="text" id="task-others" placeholder="p1, p5...">
                    </div>
                    <button class="btn" onclick="ui.confirmTask('${pid}')">–ù–∞—á–∏—Å–ª–∏—Ç—å</button>
                `);
            },

            confirmTask(pid) {
                const tid = document.getElementById('task-select').value, others = document.getElementById('task-others').value.split(',').map(x=>x.trim()).filter(x=>x);
                logic.completeTask(tid, [pid, ...others]);
                ui.closeModal();
            },

            modalWeeklyCeremony() {
                const topInf = [...state.participants].sort((a,b) => b.influence - a.influence).slice(0, 5);
                const winnerTrust = [...state.participants].sort((a,b) => b.trust - a.trust)[0];
                this.openModal(`
                    <div style="text-align:center;">
                        <h1 style="color:var(--warning);">WEEKLY CEREMONY</h1>
                        <h3>üèÜ Voice of Kurultai</h3>
                        <p>${winnerTrust.name} (+100 influence)</p>
                        <h3>–¢–æ–ø –Ω–µ–¥–µ–ª–∏ (Influence)</h3>
                        ${topInf.map(p => `<div class="list-item"><span>${p.name}</span><span>${p.influence}</span></div>`).join('')}
                        <button class="btn mt-12" onclick="ui.runWeeklyReset()">–ó–ê–í–ï–†–®–ò–¢–¨ –ù–ï–î–ï–õ–Æ</button>
                    </div>
                `);
            },

            runWeeklyReset() {
                const winnerTrust = [...state.participants].sort((a,b) => b.trust - a.trust)[0];
                winnerTrust.influence += 100;
                winnerTrust.titles.push("Voice of Kurultai");
                state.seasonWeek++;
                state.participants.forEach(p => { p.trust = 0; p.weeklyStats = { personal:0, team:0 }; });
                state.alliances = [];
                state.save(); ui.closeModal(); ui.toast('–°–µ–∑–æ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω!'); ui.render();
            },

            modalAlliance() {
                this.openModal(`
                    <h3>–ù–æ–≤—ã–π –ê–ª—å—è–Ω—Å</h3>
                    <div class="input-group"><label>–û—Ç—Ä—è–¥ 1</label><select id="a1"><option>A</option><option>B</option><option>C</option><option>D</option></select></div>
                    <div class="input-group"><label>–û—Ç—Ä—è–¥ 2</label><select id="a2"><option>B</option><option>A</option><option>C</option><option>D</option></select></div>
                    <button class="btn" onclick="ui.confirmAlliance()">–ó–∞–∫–ª—é—á–∏—Ç—å –Ω–∞ 7 –¥–Ω–µ–π</button>
                `);
            },

            confirmAlliance() {
                const s1 = document.getElementById('a1').value, s2 = document.getElementById('a2').value;
                if(s1 === s2) return ui.toast('–ù—É–∂–Ω—ã —Ä–∞–∑–Ω—ã–µ –æ—Ç—Ä—è–¥—ã');
                state.alliances.push({ s1, s2, expiry: Date.now() + 7*24*60*60*1000 });
                state.save(); ui.closeModal(); ui.toast('–ê–ª—å—è–Ω—Å —Å–æ–∑–¥–∞–Ω!'); ui.render();
            },

            buy(id) {
                const s = state.store.find(x => x.id === id), p = logic.getParticipant();
                if(p.coins < s.price) return ui.toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç');
                p.coins -= s.price;
                state.events.push({ text: `${p.name} –ø—Ä–∏–æ–±—Ä–µ–ª ${s.name}`, time: Date.now() });
                state.save(); ui.render(); ui.toast('–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!');
            },

            openModal(h) { document.getElementById('modal-inner').innerHTML = h; document.getElementById('modal').classList.add('active'); },
            closeModal(e) { if(e && e.target !== document.getElementById('modal')) return; document.getElementById('modal').classList.remove('active'); }
        };

        const app = {
            init() {
                state.load();
                if(!state.currentUser) {
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('app').classList.add('hidden');
                } else {
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    const r = state.currentUser.roleTitle.toLowerCase();
                    if(r.includes('–ø—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å') || r.includes('–∞–¥–º–∏–Ω')) document.getElementById('admin-nav').classList.remove('hidden');
                    ui.render();
                }
            }
        };

        window.onload = app.init;
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–°—Ç—É–¥–µ–Ω—Ç—Ç—ñ–∫ “ö“±—Ä—ã–ª—ã—Ç–∞–π</title>
    <style>
        :root {
            --primary: #007AFF;
            --bg: #F9F9F9;
            --card-bg: #FFFFFF;
            --text-main: #1C1C1E;
            --text-secondary: #8E8E93;
            --border: #E5E5EA;
            --shadow: 0 8px 24px rgba(0,0,0,0.04);
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background: var(--bg); 
            color: var(--text-main);
            overflow-x: hidden;
            -webkit-user-select: none;
        }

        #app { display: flex; flex-direction: column; min-height: 100vh; padding-bottom: 90px; }
        .container { padding: 16px; width: 100%; max-width: 500px; margin: 0 auto; }

        /* Auth Screen */
        .auth-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 2000;
            overflow-y: auto; display: flex; flex-direction: column;
        }
        .auth-content { padding: 40px 24px; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .auth-card { background: var(--card-bg); padding: 24px; border-radius: 24px; box-shadow: var(--shadow); }
        
        /* Typography */
        h1 { font-size: 24px; font-weight: 800; color: var(--primary); margin: 0 0 8px; text-align: center; }
        h2 { font-size: 20px; font-weight: 700; margin: 0 0 16px; }
        h3 { font-size: 17px; font-weight: 600; margin: 20px 0 12px; }

        /* Forms */
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; padding-left: 4px; }
        input, select { 
            width: 100%; padding: 14px 16px; border-radius: 14px; border: 1px solid var(--border); 
            font-size: 16px; outline: none; background: #fff; transition: border-color 0.2s;
        }
        input:focus { border-color: var(--primary); }

        /* Buttons */
        .btn { 
            width: 100%; padding: 16px; border-radius: 16px; border: none; font-size: 16px; font-weight: 600; 
            cursor: pointer; transition: all 0.2s; background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-outline { background: transparent; border: 1.5px solid var(--primary); color: var(--primary); margin-top: 12px; }
        .btn-small { padding: 8px 12px; font-size: 13px; width: auto; border-radius: 10px; }
        .btn-danger { background: var(--danger); }

        /* Header & Nav */
        header { 
            padding: 44px 16px 12px; background: rgba(255,255,255,0.8); backdrop-filter: blur(20px);
            position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center;
        }
        nav { 
            position: fixed; bottom: 0; left: 0; right: 0; height: 84px; 
            background: rgba(255,255,255,0.94); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding-top: 8px; z-index: 1000;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-secondary); font-size: 10px; flex: 1; transition: 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }

        /* Dashboard Components */
        .card { background: var(--card-bg); border-radius: 20px; padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.02); }
        .energy-box { display: flex; align-items: center; gap: 12px; margin-top: 8px; }
        .progress-container { flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #5856D6); transition: width 0.5s; }
        
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .stat-card { background: var(--card-bg); padding: 16px; border-radius: 18px; text-align: center; box-shadow: var(--shadow); }
        .stat-val { font-size: 20px; font-weight: 800; display: block; }
        .stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Lists */
        .item-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .item-row:last-child { border-bottom: none; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .badge-blue { background: #E1F0FF; color: var(--primary); }

        /* Modals */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 3000; display: none; align-items: flex-end; }
        .modal.active { display: flex; }
        .modal-content { 
            background: white; width: 100%; border-radius: 24px 24px 0 0; padding: 24px; 
            max-height: 90vh; overflow-y: auto; transform: translateY(100%); transition: 0.3s;
        }
        .modal.active .modal-content { transform: translateY(0); }

        #toast { 
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 20px; 
            font-size: 14px; z-index: 4000; display: none; white-space: nowrap;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="auth-screen">
        <div class="auth-content">
            <h1>–°—Ç—É–¥–µ–Ω—Ç—Ç—ñ–∫ “ö“±—Ä—ã–ª—ã—Ç–∞–π</h1>
            <p style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 30px;">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–ª–∞–º–µ–Ω—Ç–æ–º</p>
            
            <div id="login-box" class="auth-card">
                <h2>–í—Ö–æ–¥</h2>
                <div class="input-group">
                    <label>–ù–∏–∫–Ω–µ–π–º –∏–ª–∏ –ì—Ä—É–ø–ø–∞</label>
                    <input type="text" id="login-id" placeholder="–ù–∞–ø—Ä: –ú–∏–Ω–∏—Å—Ç—Ä">
                </div>
                <div class="input-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="btn" onclick="auth.login()">–í–æ–π—Ç–∏</button>
                <button class="btn btn-outline" onclick="auth.toggle(true)">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </div>

            <div id="register-box" class="auth-card hidden">
                <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <div class="input-group"><label>–§–ò–û –∏–ª–∏ –ù–∏–∫</label><input type="text" id="reg-name" placeholder="–ê—Ä–º–∞–Ω –ò–±—Ä–∞–≥–∏–º–æ–≤"></div>
                <div class="input-group"><label>–ì—Ä—É–ø–ø–∞</label><input type="text" id="reg-group" placeholder="–ë–î 24-1"></div>
                <div class="input-group">
                    <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                    <select id="reg-role">
                        <option value="–î–µ–ø—É—Ç–∞—Ç">–î–µ–ø—É—Ç–∞—Ç</option>
                        <option value="–ú–∏–Ω–∏—Å—Ç—Ä">–ú–∏–Ω–∏—Å—Ç—Ä</option>
                        <option value="–°–µ–∫—Ä–µ—Ç–∞—Ä—å">–°–µ–∫—Ä–µ—Ç–∞—Ä—å</option>
                        <option value="–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å">–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>–û—Ç—Ä—è–¥</label>
                    <select id="reg-squad">
                        <option value="A">–û—Ç—Ä—è–¥ A</option><option value="B">–û—Ç—Ä—è–¥ B</option>
                        <option value="C">–û—Ç—Ä—è–¥ C</option><option value="D">–û—Ç—Ä—è–¥ D</option>
                    </select>
                </div>
                <div class="input-group"><label>–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤.)</label><input type="password" id="reg-pass"></div>
                <button class="btn" onclick="auth.register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button class="btn btn-outline" onclick="auth.toggle(false)">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="hidden">
        <header>
            <div style="font-weight: 800; font-size: 18px; color: var(--primary);">“ö“∞–†–´–õ–¢–ê–ô</div>
            <div onclick="ui.showProfile()" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <span id="header-coins" style="font-weight: 700; color: var(--warning);">0 ü™ô</span>
                <div id="header-avatar" style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;"></div>
            </div>
        </header>

        <main class="container" id="view-content"></main>

        <nav>
            <a href="javascript:void(0)" class="nav-item active" onclick="ui.nav('home', this)"><span class="nav-icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></a>
            <a href="javascript:void(0)" class="nav-item" onclick="ui.nav('tasks', this)"><span class="nav-icon">üéØ</span><span>–ó–∞–¥–∞—á–∏</span></a>
            <a href="javascript:void(0)" class="nav-item" onclick="ui.nav('rating', this)"><span class="nav-icon">üèÜ</span><span>–†–µ–π—Ç–∏–Ω–≥</span></a>
            <a href="javascript:void(0)" class="nav-item" onclick="ui.nav('store', this)"><span class="nav-icon">üõçÔ∏è</span><span>–ú–∞–≥–∞–∑–∏–Ω</span></a>
            <a href="javascript:void(0)" class="nav-item" onclick="ui.nav('links', this)"><span class="nav-icon">ü§ù</span><span>–°–≤—è–∑–∫–∏</span></a>
            <a href="javascript:void(0)" id="admin-tab" class="nav-item hidden" onclick="ui.nav('admin', this)"><span class="nav-icon">‚öôÔ∏è</span><span>–ê–¥–º–∏–Ω</span></a>
        </nav>
    </div>

    <!-- MODAL -->
    <div id="modal" class="modal" onclick="ui.closeModal(event)">
        <div class="modal-content" id="modal-inner"></div>
    </div>

    <script>
        /** STATE & CONFIG **/
        const state = {
            users: [],
            participants: [],
            tasks: [],
            store: [],
            alliances: [],
            events: [],
            energy: 75,
            seasonWeek: 1,
            googleUrl: 'https://script.google.com/macros/s/AKfycbw8dxgWRVSUBKW9YNFmu7qx7mIKqdxicyHH_43eAlkTrmZEdUdVvvrq0FMsaIppttg/exec',
            currentUser: null,

            save() {
                localStorage.setItem('kurultai_db', JSON.stringify({
                    users: this.users,
                    participants: this.participants,
                    tasks: this.tasks,
                    store: this.store,
                    alliances: this.alliances,
                    events: this.events,
                    energy: this.energy,
                    seasonWeek: this.seasonWeek
                }));
            },
            load() {
                const data = localStorage.getItem('kurultai_db');
                if (data) Object.assign(this, JSON.parse(data));
                else this.initDefault();
                
                const sess = localStorage.getItem('kurultai_session');
                if (sess) this.currentUser = JSON.parse(sess);
            },
            initDefault() {
                const squads = ['A', 'B', 'C', 'D'];
                const roles = ['Strategist', 'Builder', 'Speaker', 'Support'];
                for(let i=1; i<=26; i++) {
                    this.participants.push({
                        id: 'p' + i,
                        name: '–£—á–∞—Å—Ç–Ω–∏–∫ ' + i,
                        nick: 'user' + i,
                        gameRole: roles[i % 4],
                        coins: 100, influence: 50, trust: 0,
                        squad: squads[i % 4],
                        monthlyLinks: [],
                        weeklyStats: { p: 0, t: 0 },
                        secretRole: null,
                        titles: []
                    });
                }
                this.tasks = [
                    { id: 't1', title: '–°–º–µ—à–∞–π –æ—Ç—Ä—è–¥—ã', desc: '–ö–æ–º–∞–Ω–¥–∞ –∏–∑ 3 —á–µ–ª–æ–≤–µ–∫ —Ä–∞–∑–Ω—ã—Ö –æ—Ç—Ä—è–¥–æ–≤', type: 'team', rC: 80, rI: 20, performers: [] },
                    { id: 't2', title: '–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞', desc: '–õ–∏—á–Ω–∞—è –∑–∞–¥–∞—á–∞ –Ω–∞ –ø–æ–ª—å–∑—É –ø–∞—Ä–ª–∞–º–µ–Ω—Ç–∞', type: 'personal', rC: 30, rI: 5, performers: [] }
                ];
                this.store = [
                    { id: 's1', name: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ –ø–æ–µ–∑–¥–∫—É', price: 300, type: 'ind' },
                    { id: 's2', name: '–ö–æ—Ñ–µ –º–∏—Ç–∞–ø –ø–∞—Ä–ª–∞–º–µ–Ω—Ç–∞', price: 800, type: 'team' }
                ];
                this.save();
            }
        };

        /** CRYPTO SIMULATION **/
        async function hash(str) {
            const msg = new TextEncoder().encode(str);
            const buf = await crypto.subtle.digest('SHA-256', msg);
            return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        /** AUTH MODULE **/
        const auth = {
            async register() {
                const name = document.getElementById('reg-name').value;
                const group = document.getElementById('reg-group').value;
                const role = document.getElementById('reg-role').value;
                const squad = document.getElementById('reg-squad').value;
                const pass = document.getElementById('reg-pass').value;

                if (!name || pass.length < 6) return ui.toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ');

                const hPass = await hash(pass);
                const user = { id: 'u'+Date.now(), name, group, role, squad, pass: hPass };
                
                state.users.push(user);
                // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —É—á–∞—Å—Ç–Ω–∏–∫—É –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ
                let part = state.participants.find(p => p.name === name);
                if (!part) {
                    part = {
                        id: user.id, name, nick: name, gameRole: 'Strategist', 
                        coins: 100, influence: 20, trust: 0, squad, 
                        monthlyLinks: [], weeklyStats: { p: 0, t: 0 }, titles: []
                    };
                    state.participants.push(part);
                }
                
                state.save();
                ui.toast('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
                this.toggle(false);
            },

            async login() {
                const id = document.getElementById('login-id').value;
                const pass = document.getElementById('login-pass').value;
                const hPass = await hash(pass);

                const user = state.users.find(u => (u.name === id || u.group === id) && u.pass === hPass);
                if (user) {
                    state.currentUser = user;
                    localStorage.setItem('kurultai_session', JSON.stringify(user));
                    app.init();
                } else {
                    ui.toast('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                }
            },

            toggle(isReg) {
                document.getElementById('login-box').classList.toggle('hidden', isReg);
                document.getElementById('register-box').classList.toggle('hidden', !isReg);
            }
        };

        /** UI ENGINE **/
        const ui = {
            current: 'home',

            toast(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg; t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 3000);
            },

            nav(view, el) {
                this.current = view;
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                if(el) el.classList.add('active');
                this.render();
            },

            render() {
                const container = document.getElementById('view-content');
                const p = state.participants.find(x => x.name === state.currentUser.name || x.id === state.currentUser.id);
                
                document.getElementById('header-coins').textContent = p.coins + ' ü™ô';
                document.getElementById('header-avatar').textContent = p.name[0];

                if(this.current === 'home') this.viewHome(container, p);
                if(this.current === 'tasks') this.viewTasks(container);
                if(this.current === 'rating') this.viewRating(container);
                if(this.current === 'store') this.viewStore(container, p);
                if(this.current === 'links') this.viewLinks(container, p);
                if(this.current === 'admin') this.viewAdmin(container);
            },

            viewHome(cont, p) {
                cont.innerHTML = `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:700;">–≠–Ω–µ—Ä–≥–∏—è –ü–∞—Ä–ª–∞–º–µ–Ω—Ç–∞</span>
                            <span style="font-weight:800; color:var(--primary);">${state.energy}%</span>
                        </div>
                        <div class="energy-box">
                            <div class="progress-container"><div class="progress-fill" style="width:${state.energy}%"></div></div>
                        </div>
                        <p style="font-size:12px; color:var(--text-secondary); margin-top:10px;">
                            ${state.energy > 70 ? 'üî• –í—ã—Å–æ–∫–∏–π —Ç–æ–Ω—É—Å! +10% –∫ –Ω–∞–≥—Ä–∞–¥–∞–º' : '‚öì –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º'}
                        </p>
                    </div>

                    <div class="stats-row">
                        <div class="stat-card"><span class="stat-val">${p.influence}</span><span class="stat-label">–í–ª–∏—è–Ω–∏–µ</span></div>
                        <div class="stat-card"><span class="stat-val">${p.trust}</span><span class="stat-label">–î–æ–≤–µ—Ä–∏–µ</span></div>
                    </div>

                    <h3>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h3>
                    <div class="card">
                        <div class="item-row"><span>–û—Ç—Ä—è–¥</span><span class="badge badge-blue">${p.squad}</span></div>
                        <div class="item-row"><span>–†–æ–ª—å</span><span>${p.gameRole}</span></div>
                        <div class="item-row"><span>–ì—Ä—É–ø–ø–∞</span><span>${state.currentUser.group}</span></div>
                    </div>

                    <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–ª—å—è–Ω—Å—ã</h3>
                    ${state.alliances.length ? state.alliances.map(a => `<div class="card">${a.squad1} + ${a.squad2} (–¥–æ ${a.end})</div>`).join('') : '<p style="color:var(--text-secondary)">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–ª—å—è–Ω—Å–æ–≤</p>'}
                `;
            },

            viewTasks(cont) {
                cont.innerHTML = `<h3>–ú–∏—Å—Å–∏–∏ –Ω–µ–¥–µ–ª–∏</h3>` + state.tasks.map(t => `
                    <div class="card" onclick="ui.taskAction('${t.id}')">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <span class="badge badge-blue">${t.type}</span>
                            <span style="color:var(--success); font-weight:700;">+${t.rC} ü™ô</span>
                        </div>
                        <div style="font-weight:700; margin-bottom:4px;">${t.title}</div>
                        <div style="font-size:13px; color:var(--text-secondary);">${t.desc}</div>
                    </div>
                `).join('');
            },

            viewRating(cont) {
                const sorted = [...state.participants].sort((a,b) => b.influence - a.influence);
                cont.innerHTML = `<h3>–õ–∏–¥–µ—Ä—ã –≤–ª–∏—è–Ω–∏—è</h3>` + sorted.map((p, i) => `
                    <div class="item-row">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <span style="font-weight:800; width:20px; color:var(--text-secondary);">${i+1}</span>
                            <div>
                                <div style="font-weight:600; font-size:14px;">${p.name}</div>
                                <div style="font-size:11px; color:var(--text-secondary);">–û—Ç—Ä—è–¥ ${p.squad} ‚Ä¢ ${p.gameRole}</div>
                            </div>
                        </div>
                        <div style="font-weight:700;">${p.influence} ‚ú®</div>
                    </div>
                `).join('');
            },

            viewStore(cont, p) {
                cont.innerHTML = `
                    <div class="card" style="background:var(--primary); color:white; text-align:center;">
                        <div style="font-size:12px; opacity:0.8;">–î–æ—Å—Ç—É–ø–Ω–æ</div>
                        <div style="font-size:32px; font-weight:800;">${p.coins} ü™ô</div>
                    </div>
                    <h3>–ú–∞–≥–∞–∑–∏–Ω –±–æ–Ω—É—Å–æ–≤</h3>
                ` + state.store.map(s => `
                    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:700;">${s.name}</div>
                            <div style="font-size:12px; color:var(--text-secondary);">${s.type === 'ind' ? '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ' : '–ö–æ–º–∞–Ω–¥–Ω–æ'}</div>
                        </div>
                        <button class="btn btn-small" onclick="logic.buy('${s.id}')">${s.price} ü™ô</button>
                    </div>
                `).join('');
            },

            viewLinks(cont, p) {
                cont.innerHTML = `
                    <div class="card" style="text-align:center;">
                        <h3>–°–≤—è–∑–∫–∏ –ú–µ—Å—è—Ü–∞</h3>
                        <div style="font-size:48px; font-weight:800; color:var(--primary);">${p.monthlyLinks.length}/3</div>
                        <p style="font-size:13px; color:var(--text-secondary);">–°–æ–±–µ—Ä–∏—Ç–µ 3 —Å–≤—è–∑–∫–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –ª—é–¥—å–º–∏ –¥–ª—è –±–æ–Ω—É—Å–∞ 50 ü™ô</p>
                    </div>
                    <button class="btn btn-outline" onclick="ui.modalTrust()">–í—ã–¥–∞—Ç—å –¥–æ–≤–µ—Ä–∏–µ ‚ù§Ô∏è</button>
                `;
            },

            viewAdmin(cont) {
                cont.innerHTML = `
                    <div class="card">
                        <h3>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
                        <button class="btn btn-sync" onclick="logic.syncToGoogle()" style="background:#34C759; margin-bottom:12px;">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ –¢–∞–±–ª–∏—Ü—É</button>
                        <button class="btn btn-outline" onclick="logic.ceremony()">üèÜ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ü–µ—Ä–µ–º–æ–Ω–∏—é</button>
                        <button class="btn btn-outline" onclick="logic.resetSeason()" style="border-color:var(--danger); color:var(--danger); margin-top:20px;">–°–±—Ä–æ—Å —Å–µ–∑–æ–Ω–∞</button>
                    </div>
                    <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏ (${state.participants.length})</h3>
                    <div id="admin-list">
                        ${state.participants.map(p => `<div class="item-row"><span>${p.name}</span> <button class="btn btn-small" onclick="ui.modalUser('${p.id}')">–ò–∑–º–µ–Ω–∏—Ç—å</button></div>`).join('')}
                    </div>
                `;
            },

            showProfile() {
                const p = state.participants.find(x => x.name === state.currentUser.name);
                this.openModal(`
                    <div style="text-align:center;">
                        <div style="width:64px; height:64px; border-radius:50%; background:var(--primary); color:white; margin:0 auto 16px; display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:800;">${p.name[0]}</div>
                        <h2>${p.name}</h2>
                        <p>${state.currentUser.role}</p>
                        <button class="btn btn-danger" onclick="localStorage.removeItem('kurultai_session'); location.reload();">–í—ã–π—Ç–∏</button>
                    </div>
                `);
            },

            modalTrust() {
                this.openModal(`
                    <h3>–í—ã–¥–∞—Ç—å –¥–æ–≤–µ—Ä–∏–µ</h3>
                    <div class="input-group">
                        <label>–ö–æ–º—É –≤—ã–¥–∞–µ–º?</label>
                        <select id="trust-target">
                            ${state.participants.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <button class="btn" onclick="logic.giveTrust()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å +10 Trust</button>
                `);
            },

            taskAction(id) {
                const t = state.tasks.find(x => x.id === id);
                this.openModal(`
                    <h3>${t.title}</h3>
                    <p>${t.desc}</p>
                    <button class="btn" onclick="ui.closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                `);
            },

            openModal(html) {
                document.getElementById('modal-inner').innerHTML = html;
                document.getElementById('modal').classList.add('active');
            },
            closeModal(e) {
                if(e && e.target !== document.getElementById('modal')) return;
                document.getElementById('modal').classList.remove('active');
            }
        };

        /** LOGIC MODULE **/
        const logic = {
            async syncToGoogle() {
                ui.toast('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...');
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ –ø—Ä—è–º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ (GAS —Ç—Ä–µ–±—É–µ—Ç POST)
                    await fetch(state.googleUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            participants: state.participants,
                            energy: state.energy,
                            week: state.seasonWeek
                        })
                    });
                    ui.toast('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!');
                } catch(e) {
                    ui.toast('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
                }
            },

            giveTrust() {
                const tid = document.getElementById('trust-target').value;
                const target = state.participants.find(x => x.id === tid);
                target.trust += 10;
                state.save();
                ui.closeModal();
                ui.toast('–î–æ–≤–µ—Ä–∏–µ –ø–µ—Ä–µ–¥–∞–Ω–æ!');
                ui.render();
            },

            buy(id) {
                const s = state.store.find(x => x.id === id);
                const p = state.participants.find(x => x.name === state.currentUser.name);
                if(p.coins < s.price) return ui.toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç');
                p.coins -= s.price;
                state.save();
                ui.toast('–ö—É–ø–ª–µ–Ω–æ: ' + s.name);
                ui.render();
            },

            ceremony() {
                if(!confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –Ω–µ–¥–µ–ª—é?')) return;
                state.seasonWeek++;
                state.energy += 5;
                state.save();
                ui.toast('–¶–µ—Ä–µ–º–æ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ù–µ–¥–µ–ª—è ' + state.seasonWeek);
                ui.render();
            },

            resetSeason() {
                if(!confirm('–≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è! –í—ã —É–≤–µ—Ä–µ–Ω—ã?')) return;
                localStorage.clear();
                location.reload();
            }
        };

        const app = {
            init() {
                state.load();
                if(!state.currentUser) {
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('app').classList.add('hidden');
                } else {
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    
                    const role = state.currentUser.role.toLowerCase();
                    if(role.includes('–ø—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å') || role.includes('–∞–¥–º–∏–Ω')) {
                        document.getElementById('admin-tab').classList.remove('hidden');
                    }
                    ui.render();
                }
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
